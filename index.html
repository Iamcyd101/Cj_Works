<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Bridge International Academy - Placement Test</title>
    <!-- Import html2pdf library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            /* Theme: VBIA Official Logo Colors */
            --primary: #054b60;
            /* Deep Teal/Blue from the outer ring and shield */
            --secondary: #e51c24;
            /* Flame Red from the center */
            --accent: #d32f2f;
            /* Alert Red */
            --success: #2e7d32;
            /* Success Green */
            --card: #ffffff;
            --text: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-user-select: none;
            /* Prevent text selection */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow-x: hidden;
            background-color: #87CEEB;
            /* Fallback Sky Blue */
        }

        /* --- ANIMATED SCENERY BACKGROUND --- */
        .scenery-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            background: linear-gradient(to bottom, #4DB8FF 0%, #E0F6FF 60%, #CDEBCA 100%);
        }

        /* The Sun */
        .sun {
            position: absolute;
            top: 8%;
            right: 15%;
            width: 90px;
            height: 90px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 50px 20px rgba(255, 215, 0, 0.4);
            animation: pulseSun 4s infinite alternate ease-in-out;
        }

        /* Moving Clouds */
        .cloud {
            position: absolute;
            left: -250px;
            /* Start entirely off-screen to the left */
            opacity: 0.9;
            filter: drop-shadow(0 5px 15px rgba(255, 255, 255, 0.5));
            animation: floatCloud 60s linear infinite;
            will-change: transform;
            /* Smooth rendering */
        }

        /* Negative animation delays make them appear on-screen immediately on load */
        .c1 {
            width: 160px;
            top: 12%;
            animation-duration: 55s;
            animation-delay: -15s;
        }

        .c2 {
            width: 120px;
            top: 28%;
            animation-duration: 70s;
            animation-delay: -45s;
            opacity: 0.7;
        }

        .c3 {
            width: 200px;
            top: 8%;
            animation-duration: 45s;
            animation-delay: -30s;
        }

        .c4 {
            width: 140px;
            top: 22%;
            animation-duration: 65s;
            animation-delay: -60s;
            opacity: 0.8;
        }

        /* Airplane (Horizontal Flight) */
        .airplane {
            position: absolute;
            top: 20%;
            right: -100px;
            width: 60px;
            height: 60px;
            animation: flyPlane 25s linear infinite;
            animation-delay: 5s;
            opacity: 0.85;
        }

        .airplane svg {
            transform: rotate(-90deg);
            /* Points the airplane perfectly horizontal (Leftward) */
        }

        /* Birds */
        .birds {
            position: absolute;
            top: 25%;
            left: -100px;
            display: flex;
            gap: 10px;
            animation: flyBirds 30s linear infinite;
            animation-delay: 2s;
        }

        .bird {
            width: 25px;
            height: 25px;
        }

        /* Mountains */
        .mountains {
            position: absolute;
            bottom: 15%;
            width: 100%;
            height: 35vh;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .mountain {
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border-left: 20vw solid transparent;
            border-right: 20vw solid transparent;
        }

        .m1 {
            border-bottom: 30vh solid #81C784;
            left: -5vw;
            z-index: 1;
        }

        .m2 {
            border-bottom: 40vh solid #66BB6A;
            left: 25vw;
            z-index: 2;
            border-left-width: 25vw;
            border-right-width: 25vw;
        }

        .m3 {
            border-bottom: 25vh solid #4CAF50;
            right: -10vw;
            z-index: 1;
            border-left-width: 25vw;
            border-right-width: 25vw;
        }

        /* Ground */
        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 18%;
            background: linear-gradient(to bottom, #8BC34A, #388E3C);
            z-index: 3;
            border-top: 4px solid #689F38;
        }

        /* Scene Elements (Trees Only) */
        .scene-element {
            position: absolute;
            z-index: 4;
        }

        .tree {
            width: 40px;
            height: 50px;
            bottom: 16%;
        }

        /* Keyframes */
        @keyframes pulseSun {
            0% {
                transform: scale(1);
                opacity: 0.9;
            }

            100% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes flyPlane {
            0% {
                right: -100px;
            }

            100% {
                right: 110vw;
            }
        }

        @keyframes flyBirds {
            0% {
                left: -100px;
                transform: translateY(0);
            }

            25% {
                transform: translateY(-15px);
            }

            50% {
                transform: translateY(0);
            }

            75% {
                transform: translateY(15px);
            }

            100% {
                left: 110vw;
                transform: translateY(0);
            }
        }

        @keyframes floatCloud {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(calc(100vw + 500px));
            }
        }

        /* --- MAIN CONTAINER --- */
        .container {
            background: rgba(255, 255, 255, 0.94);
            /* Semi-transparent white */
            backdrop-filter: blur(12px);
            /* Glassmorphism effect */
            -webkit-backdrop-filter: blur(12px);
            width: 95%;
            max-width: 800px;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            border-top: 8px solid var(--primary);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            margin: 20px 0;
            position: relative;
            z-index: 10;
            /* Keep above scenery */
        }

        .logo-area {
            margin-bottom: 25px;
        }

        .logo-area img {
            max-height: 140px;
            width: auto;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 5px;
            font-weight: 800;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        h2 {
            color: #555;
            font-size: 1.1rem;
            margin-top: 0;
            font-weight: 500;
        }

        p {
            color: var(--text);
            line-height: 1.6;
            font-size: 1.05rem;
        }

        /* Input Fields */
        .input-group {
            margin: 20px 0;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary);
            font-size: 1rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #d1d9e0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #ffffff;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(5, 75, 96, 0.1);
            outline: none;
        }

        /* Level Grid */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        /* Buttons */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background-color: #033240;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Audio Control Buttons */
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn-speak {
            border: none;
            padding: 10px 18px;
            font-size: 0.95rem;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s, filter 0.2s;
        }

        .btn-speak:active {
            transform: scale(0.96);
        }

        .btn-story {
            background-color: var(--secondary);
            color: white;
        }

        .btn-story:hover {
            filter: brightness(0.9);
        }

        .btn-read-q {
            background-color: #e6f0f2;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-read-q:hover {
            background-color: #d2e1e6;
        }

        .btn-option {
            display: block;
            width: 100%;
            background: white;
            color: var(--text);
            border: 2px solid #e0e0e0;
            margin: 12px 0;
            text-align: left;
            padding: 16px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .btn-option:hover {
            border-color: var(--primary);
            background: #f8fafb;
            transform: translateX(5px);
        }

        .btn-option.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateX(5px);
        }

        /* Assessor Grading Buttons */
        .grading-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 25px;
            padding: 20px;
            background: #f8fafb;
            border-radius: 10px;
            border: 2px dashed #b0c4cc;
        }

        .grading-grid::before {
            content: "Assessor Grading Area üìã";
            grid-column: 1 / -1;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .btn-grade {
            padding: 14px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: white;
            font-size: 0.95rem;
            transition: opacity 0.2s;
        }

        .btn-grade:hover {
            opacity: 0.9;
        }

        .grade-100 {
            background-color: #2e7d32;
        }

        .grade-80 {
            background-color: #7cb342;
        }

        .grade-60 {
            background-color: #fdd835;
            color: #333;
        }

        .grade-40 {
            background-color: #fb8c00;
        }

        .grade-20 {
            background-color: #e53935;
        }

        .grade-0 {
            background-color: #424242;
        }

        /* Speaking Question List */
        .speaking-list {
            text-align: left;
            margin: 15px auto;
            padding: 20px;
            font-size: 1.15rem;
            color: #333;
            list-style-type: none;
            max-width: 90%;
            background: #f8fafb;
            border-radius: 8px;
            border-left: 5px solid var(--primary);
        }

        .speaking-list li {
            margin-bottom: 15px;
            padding-left: 30px;
            position: relative;
        }

        .speaking-list li::before {
            content: "‚û¢";
            position: absolute;
            left: 0;
            top: 0;
            color: var(--secondary);
            font-weight: bold;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 6px;
            margin-bottom: 25px;
            height: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.4s ease-out;
        }

        /* Results */
        .score-card {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: left;
            border: 2px solid #e0e0e0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
            color: #555;
        }

        .pass {
            color: var(--success);
            font-weight: 800;
            font-size: 1.6rem;
        }

        .fail {
            color: var(--accent);
            font-weight: 800;
            font-size: 1.6rem;
        }

        .subject-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            background: var(--primary);
            color: white;
            font-size: 0.9rem;
            margin-bottom: 15px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sub-score-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 20px 0;
            padding-left: 15px;
            border-left: 3px solid var(--secondary);
        }

        .sub-score-list li {
            font-size: 0.95rem;
            color: #444;
            margin-bottom: 6px;
        }

        #upload-status {
            font-size: 0.95rem;
            margin-top: 15px;
            font-weight: bold;
            color: #666;
        }

        /* --- MODERN PDF STYLES --- */
        #pdf-export-container {
            display: none;
            background: white;
            font-family: 'Segoe UI', sans-serif;
            color: #333;
            width: 794px;
            /* Fixed width mapped perfectly for A4 (794px at 96 DPI) */
            box-sizing: border-box;
            margin: 0 auto;
        }

        .pdf-header-bar {
            background-color: var(--primary);
            color: white;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 5px solid var(--secondary);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .pdf-logo {
            height: 60px;
            width: auto;
            object-fit: contain;
            background-color: transparent;
        }

        .pdf-title-wrapper {
            text-align: right;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .pdf-title-wrapper h1 {
            color: white;
            margin: 0;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pdf-title-wrapper p {
            color: rgba(255, 255, 255, 0.9);
            margin: 5px 0 0;
            font-size: 14px;
        }

        .pdf-body {
            padding: 30px;
        }

        .pdf-info-grid {
            display: table;
            width: 100%;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .pdf-info-row {
            display: table-row;
        }

        .pdf-info-cell {
            display: table-cell;
            width: 50%;
            padding-bottom: 20px;
            vertical-align: top;
        }

        .pdf-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            display: block;
            font-weight: 600;
        }

        .pdf-value {
            font-size: 18px;
            font-weight: bold;
            color: #222;
        }

        .pdf-divider {
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 30px;
            width: 100%;
            display: block;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .pdf-table th {
            text-align: left;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding: 12px 10px;
            font-size: 13px;
            text-transform: uppercase;
        }

        .pdf-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
            color: #444;
        }

        .pdf-table .total-row td {
            border-top: 2px solid var(--primary);
            border-bottom: none;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            padding-top: 20px;
        }

        .pdf-sub-row td {
            padding: 5px 10px 5px 30px;
            font-size: 14px;
            color: #666;
            border-bottom: none;
        }

        .pdf-verdict-container {
            margin-top: 10px;
            text-align: center;
            page-break-inside: avoid;
        }

        .pdf-verdict-badge {
            display: block;
            padding: 15px;
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }

        .pdf-verdict-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--success);
            display: block;
            margin-bottom: 5px;
        }

        .pdf-verdict-subtitle {
            font-size: 16px;
            color: #555;
        }

        .pdf-footer {
            margin-top: 20px;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #aaa;
            page-break-inside: avoid;
        }

        .signature-line {
            width: 200px;
            border-top: 1px solid #333;
            margin-top: 40px;
            padding-top: 5px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media print {
            .scenery-wrapper {
                display: none !important;
            }

            .container {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
                background: white;
            }

            body {
                background: white;
            }

            button {
                display: none !important;
            }
        }
    </style>
</head>

<body oncontextmenu="return false;">

    <!-- SCENERY BACKGROUND WRAPPER -->
    <div class="scenery-wrapper">
        <!-- Sky Elements -->
        <div class="sun"></div>

        <!-- SVG Clouds immediately visible -->
        <div class="cloud c1">
            <svg viewBox="0 0 24 24" fill="#ffffff">
                <path
                    d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.36 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z" />
            </svg>
        </div>
        <div class="cloud c2">
            <svg viewBox="0 0 24 24" fill="#ffffff">
                <path
                    d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.36 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z" />
            </svg>
        </div>
        <div class="cloud c3">
            <svg viewBox="0 0 24 24" fill="#ffffff">
                <path
                    d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.36 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z" />
            </svg>
        </div>
        <div class="cloud c4">
            <svg viewBox="0 0 24 24" fill="#ffffff">
                <path
                    d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.36 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z" />
            </svg>
        </div>

        <!-- Airplane (SVG) -->
        <div class="airplane">
            <svg viewBox="0 0 24 24" fill="#ffffff" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
                <path
                    d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z" />
            </svg>
        </div>

        <!-- Birds -->
        <div class="birds">
            <div class="bird"><svg viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2"
                    stroke-linecap="round">
                    <path d="M2 14c5-3 8-1 10 2 2-3 5-5 10-2" />
                </svg></div>
            <div class="bird" style="margin-top: 15px;"><svg viewBox="0 0 24 24" fill="none" stroke="#333"
                    stroke-width="2" stroke-linecap="round">
                    <path d="M2 14c5-3 8-1 10 2 2-3 5-5 10-2" />
                </svg></div>
            <div class="bird" style="margin-top: 5px; margin-left: 5px;"><svg viewBox="0 0 24 24" fill="none"
                    stroke="#333" stroke-width="2" stroke-linecap="round">
                    <path d="M2 14c5-3 8-1 10 2 2-3 5-5 10-2" />
                </svg></div>
        </div>

        <!-- Mountains -->
        <div class="mountains">
            <div class="mountain m1"></div>
            <div class="mountain m2"></div>
            <div class="mountain m3"></div>
        </div>

        <!-- Ground & Landscape Details -->
        <div class="ground"></div>

        <!-- Landscape SVG Assets placed absolutely (Trees Only) -->
        <div class="scene-element tree" style="left: 8%;">
            <svg viewBox="0 0 24 24" fill="#1B5E20">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#5D4037" />
            </svg>
        </div>
        <div class="scene-element tree" style="left: 28%; bottom: 19%; transform: scale(0.7);">
            <svg viewBox="0 0 24 24" fill="#2E7D32">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#795548" />
            </svg>
        </div>
        <div class="scene-element tree" style="right: 12%;">
            <svg viewBox="0 0 24 24" fill="#1B5E20">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#5D4037" />
            </svg>
        </div>
        <div class="scene-element tree" style="right: 30%; bottom: 19%; transform: scale(0.7);">
            <svg viewBox="0 0 24 24" fill="#388E3C">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#795548" />
            </svg>
        </div>
        <div class="scene-element tree" style="left: 18%; bottom: 14%; transform: scale(1.1);">
            <svg viewBox="0 0 24 24" fill="#4CAF50">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#5D4037" />
            </svg>
        </div>
        <div class="scene-element tree" style="left: 38%; bottom: 17%; transform: scale(0.8);">
            <svg viewBox="0 0 24 24" fill="#2E7D32">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#795548" />
            </svg>
        </div>
        <div class="scene-element tree" style="right: 22%; bottom: 15%; transform: scale(0.9);">
            <svg viewBox="0 0 24 24" fill="#388E3C">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#5D4037" />
            </svg>
        </div>
        <div class="scene-element tree" style="right: 42%; bottom: 18%; transform: scale(0.6);">
            <svg viewBox="0 0 24 24" fill="#1B5E20">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#795548" />
            </svg>
        </div>
        <div class="scene-element tree" style="left: 48%; bottom: 13%; transform: scale(1.2);">
            <svg viewBox="0 0 24 24" fill="#4CAF50">
                <path d="M11,21V16H8L12,9L16,16H13V21H11M12,2L8,9H16L12,2Z" />
                <rect x="11" y="16" width="2" height="6" fill="#5D4037" />
            </svg>
        </div>
    </div>

    <!-- MAIN TEST CONTAINER -->
    <div class="container">
        <div class="logo-area">
            <!-- Official School Logo -->
            <img src="VBIA_LOGO.PNG" id="main-logo" alt="Vision Bridge International Academy Logo"
                onerror="this.style.display='none'">
        </div>

        <!-- Screen 1: Registration -->
        <div id="registration-screen" class="screen active">
            <h1>Vision Bridge International Academy</h1>
            <h2>Digital Placement Test</h2>
            <p>Please enter the candidate and assessor details to begin.</p>

            <div class="input-group">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter Full Name" required>
            </div>
            <div class="input-group">
                <label for="assessor-name">Assessor Name:</label>
                <input type="text" id="assessor-name" placeholder="Enter Teacher/Assessor Name" required>
            </div>

            <!-- CAMPUS DROPDOWN -->
            <div class="input-group">
                <label for="campus-select">Campus:</label>
                <select id="campus-select" required>
                    <option value="" disabled selected>-- Select Campus --</option>
                    <option value="BKK Campus">BKK Campus</option>
                    <option value="Sen Sok Campus">Sen Sok Campus</option>
                    <option value="Campus 3">Campus 3</option>
                </select>
            </div>

            <div id="error-msg"></div>

            <button class="btn" onclick="goToLevelSelection()" style="width: 100%; margin-top: 15px;">Continue
                ‚û°Ô∏è</button>
        </div>

        <!-- Screen 2: Level Selection -->
        <div id="level-screen" class="screen">
            <h1>Select Level</h1>
            <p>Which grade level is <span id="display-student-name" style="font-weight:bold; color:var(--primary)">the
                    student</span> applying for?</p>
            <div class="level-grid" id="level-buttons">
                <!-- Buttons generated by JS -->
            </div>
            <br>
            <button class="btn" style="background:#999; font-size: 0.9rem;" onclick="location.reload()">‚¨ÖÔ∏è Back</button>
        </div>

        <!-- Screen 3: Quiz -->
        <div id="quiz-screen" class="screen">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="subject-badge" id="subject-badge">Subject</div>

            <!-- Audio Controls -->
            <div class="audio-controls">
                <!-- Story Button: Shows ONLY if isStory=true -->
                <button id="btn-listen-story" class="btn-speak btn-story" style="display:none;"
                    onclick="playListeningStory()">üîä Listen to Story</button>

                <!-- Read Question Button: Shows for ALL questions -->
                <button id="btn-read-question" class="btn-speak btn-read-q" onclick="speakQuestionText()">üó£Ô∏è Read
                    Question</button>
            </div>

            <h3 id="question-text" style="font-size: 1.4rem; margin: 15px 0; color: var(--primary);">Question text...
            </h3>

            <!-- Display for Reading/Writing Prompts -->
            <div id="prompt-display"
                style="font-size: 1.2rem; color: #444; margin-bottom: 25px; padding: 15px; background: #f8fafb; border-left: 4px solid var(--secondary); border-radius: 4px; display:none; font-weight: 500;">
            </div>

            <!-- Speaking List Display -->
            <ul id="speaking-display" class="speaking-list" style="display:none;">
                <!-- Injected by JS -->
            </ul>

            <!-- Writing Input (Visible to student in Writing Section) -->
            <div id="writing-container" style="display:none; text-align:left;">
                <div class="input-group">
                    <label>Student Answer:</label>
                    <textarea id="writing-input" rows="6" placeholder="Student types here..."></textarea>
                </div>
            </div>

            <!-- MCQ Options -->
            <div id="options-container">
                <!-- Options generated by JS -->
            </div>

            <!-- Assessor Grading Buttons (Hidden by default) -->
            <div id="assessor-grading-container" class="grading-grid" style="display:none;">
                <button class="btn-grade grade-100" onclick="gradeAssessorTask(100)">Excellent (100%)</button>
                <button class="btn-grade grade-80" onclick="gradeAssessorTask(80)">Good (80%)</button>
                <button class="btn-grade grade-60" onclick="gradeAssessorTask(60)">Average (60%)</button>
                <button class="btn-grade grade-40" onclick="gradeAssessorTask(40)">Below Avg (40%)</button>
                <button class="btn-grade grade-20" onclick="gradeAssessorTask(20)">Needs Support (20%)</button>
                <button class="btn-grade grade-0" onclick="gradeAssessorTask(0)">No Response (0%)</button>
            </div>

            <br>
            <button class="btn" id="next-btn" style="display:none; width: 100%; margin-top: 15px;"
                onclick="nextQuestion()">Next Question ‚û°Ô∏è</button>
        </div>

        <!-- Screen 4: Results -->
        <div id="result-screen" class="screen">
            <h1>Assessment Report</h1>
            <p>Placement Test Results</p>

            <!-- Visual Score Card -->
            <div class="score-card" id="screen-score-card">
                <div class="info-row">
                    <span><strong>Student:</strong> <span id="res-student"></span></span>
                    <span><strong>Assessor:</strong> <span id="res-assessor"></span></span>
                </div>
                <div class="info-row">
                    <span><strong>Campus:</strong> <span id="res-campus"></span></span>
                    <span><strong>Level:</strong> <span id="res-level"></span></span>
                </div>
                <div class="info-row" style="border:none; padding-bottom:0;">
                    <span><strong>Date:</strong> <span id="res-date"></span></span>
                </div>
                <hr style="border:1px solid #eee; margin:20px 0;">
                <h3 style="color:var(--primary); margin-top:0;">Score Breakdown:</h3>
                <p><strong>üá¨üáß English Total (50%):</strong> <span id="score-eng">0</span>%</p>
                <ul class="sub-score-list">
                    <li>Listening & Grammar: <span id="score-eng-mcq">0</span>%</li>
                    <li>Reading Aloud: <span id="score-eng-read">0</span>%</li>
                    <li>Writing: <span id="score-eng-write">0</span>%</li>
                    <li>Speaking: <span id="score-eng-speak">0</span>%</li>
                </ul>
                <p><strong>üßÆ Math (30%):</strong> <span id="score-math">0</span>%</p>
                <p><strong>üî¨ Science (20%):</strong> <span id="score-sci">0</span>%</p>
                <hr style="border:1px solid #eee; margin:20px 0;">
                <h2 style="color:var(--primary); text-align:center; font-size: 2rem; margin-bottom: 0;">Final Score:
                    <span id="final-score">0</span>/100
                </h2>
            </div>

            <div id="final-verdict" style="margin-bottom: 25px;"></div>

            <!-- Webhook Status Indicator -->
            <div id="upload-status"></div>
            <br>

            <!-- Download PDF Button -->
            <button class="btn" style="background: var(--secondary); width: 100%; margin-bottom: 15px;"
                onclick="downloadPDF()">Download PDF Report üì•</button>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" style="flex: 1; font-size: 0.95rem; padding: 12px;"
                    onclick="location.reload()">Start New üîÑ</button>
                <button class="btn" style="flex: 1; background: #333; font-size: 0.95rem; padding: 12px;"
                    onclick="window.print()">Print üñ®Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- MODERN PDF TEMPLATE -->
    <div id="pdf-export-container">
        <div class="pdf-header-bar">
            <img src="VBIA_LOGO.PNG" class="pdf-logo" alt="VBIA Logo">
            <div class="pdf-title-wrapper">
                <h1>Vision Bridge International Academy</h1>
                <p>Official Digital Placement Report</p>
            </div>
        </div>

        <div class="pdf-body">
            <!-- Modern Grid Layout for Info -->
            <div class="pdf-info-grid">
                <div class="pdf-info-row">
                    <div class="pdf-info-cell">
                        <span class="pdf-label">Candidate Name</span>
                        <span class="pdf-value" id="pdf-student">Student Name</span>
                    </div>
                    <div class="pdf-info-cell">
                        <span class="pdf-label">Campus</span>
                        <span class="pdf-value" id="pdf-campus">Campus Name</span>
                    </div>
                </div>
                <div class="pdf-info-row">
                    <div class="pdf-info-cell">
                        <span class="pdf-label">Assessment Date</span>
                        <span class="pdf-value" id="pdf-date">Date</span>
                    </div>
                    <div class="pdf-info-cell">
                        <span class="pdf-label">Assessed By</span>
                        <span class="pdf-value" id="pdf-assessor">Teacher Name</span>
                    </div>
                </div>
            </div>

            <!-- DIVIDER LINE -->
            <div class="pdf-divider"></div>

            <!-- Clean Score Table -->
            <table class="pdf-table">
                <thead>
                    <tr>
                        <th>Subject Area</th>
                        <th>Weight</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>üá¨üáß English Language (Total)</td>
                        <td>50%</td>
                        <td id="pdf-eng-score">0%</td>
                    </tr>
                    <!-- Sub rows for English -->
                    <tr class="pdf-sub-row">
                        <td colspan="3">
                            ‚Ä¢ Listening & Grammar: <span id="pdf-eng-mcq">0</span>%<br>
                            ‚Ä¢ Reading Aloud: <span id="pdf-eng-read">0</span>%<br>
                            ‚Ä¢ Writing: <span id="pdf-eng-write">0</span>%<br>
                            ‚Ä¢ Speaking: <span id="pdf-eng-speak">0</span>%
                        </td>
                    </tr>

                    <tr>
                        <td>üßÆ Mathematics</td>
                        <td>30%</td>
                        <td id="pdf-math-score">0%</td>
                    </tr>
                    <tr>
                        <td>üî¨ Science</td>
                        <td>20%</td>
                        <td id="pdf-sci-score">0%</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2">FINAL WEIGHTED SCORE</td>
                        <td id="pdf-final-score">0/100</td>
                    </tr>
                </tbody>
            </table>

            <!-- Verdict Badge -->
            <div class="pdf-verdict-container">
                <div id="pdf-verdict-box" class="pdf-verdict-badge">
                    <!-- Content injected via JS -->
                </div>
            </div>

            <!-- Footer / Signature -->
            <div class="pdf-footer">
                <div>
                    <div class="signature-line">Assessor Signature</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Disable right click to limit view source casually
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- DATABASE WITH LISTENING & WRITING (K2 - P6) ---
        const quizData = {
            "K2": {
                "English": {
                    story: "The cat is sitting on the soft mat. It is a big, orange cat. The cat is sleeping because it is tired. The cat is happy.",
                    questions: [
                        { q: "Where is the cat?", options: ["On the mat", "In the box", "Under the table", "On the chair"], ans: 0, isStory: true },
                        { q: "How does the cat feel?", options: ["Sad", "Happy", "Angry", "Sleepy"], ans: 1, isStory: true },
                        { q: "Which letter starts the word 'Apple'?", options: ["B", "A", "C", "D"], ans: 1 },
                        { q: "Look at the picture of a üê±. What is it?", options: ["Dog", "Cat", "Cow", "Pig"], ans: 1 },
                        { q: "Which word rhymes with 'Bat'?", options: ["Car", "Hat", "Dog", "Sun"], ans: 1 },
                        { q: "'The ball is _____ the box.' (Ball inside)", options: ["in", "on", "under", "up"], ans: 0 },
                        { q: "Choose the action word (verb):", options: ["Blue", "Run", "Boy", "Happy"], ans: 1 },
                        { q: "Which word is a color?", options: ["Three", "Red", "Table", "Go"], ans: 1 },
                        { q: "Complete the word: D_G üê∂", options: ["A", "O", "I", "E"], ans: 1 },
                        { q: "Which is the capital letter 'm'?", options: ["M", "n", "w", "z"], ans: 0 },
                        { q: "Which one is small?", options: ["Elephant", "Ant", "House", "Tree"], ans: 1 },
                        { q: "One cat, two ______?", options: ["Cat", "Cats", "Cates", "Kat"], ans: 1 }
                    ],
                    writingPrompt: "Write your name (Assessor Grades).",
                    readingPrompt: "Read aloud: 'The dog runs fast.'",
                    speakingQuestions: [
                        "What is your name?",
                        "How old are you?",
                        "What color do you like?"
                    ]
                },
                "Math": [
                    { q: "Count the stars: ‚òÖ ‚òÖ ‚òÖ", options: ["2", "4", "3", "5"], ans: 2 },
                    { q: "What is 2 + 2?", options: ["3", "4", "5", "6"], ans: 1 },
                    { q: "Which shape is round?", options: ["Square", "Triangle", "Circle", "Star"], ans: 2 },
                    { q: "Which number is missing? 1, 2, __, 4", options: ["3", "5", "6", "0"], ans: 0 },
                    { q: "Which object is bigger?", options: ["An Elephant", "An Ant", "A Mouse", "A Bee"], ans: 0 },
                    { q: "How many fingers are on one hand?", options: ["4", "5", "10", "2"], ans: 1 },
                    { q: "5 - 1 = ?", options: ["3", "4", "5", "6"], ans: 1 },
                    { q: "Which number is Ten?", options: ["01", "10", "100", "1"], ans: 1 },
                    { q: "Which shape has 3 sides?", options: ["Circle", "Triangle", "Square", "Star"], ans: 1 },
                    { q: "1 + 1 + 1 = ?", options: ["2", "3", "4", "1"], ans: 1 }
                ],
                "Science": [
                    { q: "Is a dog a living thing?", options: ["Yes", "No"], ans: 0 },
                    { q: "We use our eyes to:", options: ["Hear", "See", "Smell", "Touch"], ans: 1 },
                    { q: "Where do fish live?", options: ["In the sky", "In the water", "In a tree", "On the grass"], ans: 1 },
                    { q: "Which one is hot?", options: ["Ice Cream", "Fire", "Snow", "Water"], ans: 1 },
                    { q: "A bird has:", options: ["Wings", "Hands", "Fins", "Wheels"], ans: 0 },
                    { q: "What falls from the sky?", options: ["Rocks", "Rain", "Trees", "Cars"], ans: 1 },
                    { q: "When do we sleep?", options: ["At night", "At breakfast", "At lunch", "At school"], ans: 0 },
                    { q: "A baby chicken is called a:", options: ["Puppy", "Chick", "Kitten", "Calf"], ans: 1 }
                ]
            },
            "P1": {
                "English": {
                    story: "Tom has a big, shiny red ball. He goes to the park every Saturday to play with his dog, Rex. Rex loves to run fast and catch the ball.",
                    questions: [
                        { q: "What does Tom have?", options: ["A blue car", "A red ball", "A green hat", "A yellow bike"], ans: 1, isStory: true },
                        { q: "Where does Tom go?", options: ["To the school", "To the park", "To the shop", "To home"], ans: 1, isStory: true },
                        { q: "Who is Rex?", options: ["His cat", "His bird", "His dog", "His friend"], ans: 2, isStory: true },
                        { q: "The cat is sleeping _____ the bed.", options: ["on", "happy", "run", "fast"], ans: 0 },
                        { q: "Which word rhymes with 'Cat'?", options: ["Dog", "Hat", "Ball", "Fish"], ans: 1 },
                        { q: "Choose the correct sentence.", options: ["I has a book.", "I have a book.", "I having books.", "Me has book."], ans: 1 },
                        { q: "What is the plural of 'Apple'?", options: ["Apple", "Apples", "Applez", "Appless"], ans: 1 },
                        { q: "Which word is a verb (action word)?", options: ["Red", "Jump", "Big", "Table"], ans: 1 },
                        { q: "'She _____ a teacher.'", options: ["are", "is", "am", "be"], ans: 1 },
                        { q: "Choose the opposite of 'Big'.", options: ["Large", "Small", "Tall", "Fat"], ans: 1 },
                        { q: "Which word needs a capital letter?", options: ["cat", "monday", "run", "blue"], ans: 1 },
                        { q: "The book is _____ the table.", options: ["under", "happy", "running", "fast"], ans: 0 },
                        { q: "My sister is a girl. _____ is nice.", options: ["He", "She", "It", "They"], ans: 1 }
                    ],
                    writingPrompt: "Write about your favorite toy.",
                    readingPrompt: "Read aloud: 'I like to play with my friends.'",
                    speakingQuestions: [
                        "What is your favorite toy?",
                        "Do you have any pets?",
                        "What do you like to do at school?"
                    ]
                },
                "Math": [
                    { q: "What is 5 + 4?", options: ["8", "9", "10", "7"], ans: 1 },
                    { q: "Which number is smaller than 10?", options: ["12", "20", "8", "15"], ans: 2 },
                    { q: "If you have 3 apples and buy 2 more, how many do you have?", options: ["4", "5", "6", "1"], ans: 1 },
                    { q: "Which shape has 3 sides?", options: ["Square", "Circle", "Triangle", "Star"], ans: 2 },
                    { q: "What number comes next? 10, 20, 30, ___", options: ["35", "40", "50", "25"], ans: 1 },
                    { q: "Write 'Sixteen' as a number.", options: ["60", "61", "16", "06"], ans: 2 },
                    { q: "15 - 5 = ?", options: ["10", "20", "11", "5"], ans: 0 },
                    { q: "Which object is heavy?", options: ["A feather", "A truck", "A pencil", "A leaf"], ans: 1 },
                    { q: "10 + 10 = ?", options: ["10", "20", "30", "100"], ans: 1 },
                    { q: "Count backwards: 5, 4, 3, __", options: ["1", "2", "6", "0"], ans: 1 }
                ],
                "Science": [
                    { q: "What do humans need to live?", options: ["Candy", "Toys", "Water", "TV"], ans: 2 },
                    { q: "Which one is a plant?", options: ["Rose", "Rock", "Rabbit", "Rain"], ans: 0 },
                    { q: "Which animal lives in water?", options: ["Cat", "Fish", "Bird", "Lion"], ans: 1 },
                    { q: "We use our nose to:", options: ["See", "Hear", "Smell", "Walk"], ans: 2 },
                    { q: "Is a stone a living thing?", options: ["Yes", "No"], ans: 1 },
                    { q: "The sun gives us:", options: ["Water", "Light", "Air", "Food"], ans: 1 },
                    { q: "Which animal eats only plants?", options: ["Lion", "Rabbit", "Tiger", "Shark"], ans: 1 },
                    { q: "A car is made of:", options: ["Paper", "Metal", "Water", "Leaves"], ans: 1 }
                ]
            },
            "P2": {
                "English": {
                    story: "Sarah goes to the zoo with her family. First, she sees a big grey elephant eating green grass. Then, she walks to see the tall giraffes eating leaves from the top of the trees. It is a fun day.",
                    questions: [
                        { q: "Where does Sarah go?", options: ["To school", "To the park", "To the zoo", "To the shop"], ans: 2, isStory: true },
                        { q: "What is the elephant eating?", options: ["Meat", "Grass", "Ice cream", "Leaves"], ans: 1, isStory: true },
                        { q: "Which animal is tall?", options: ["Elephant", "Ant", "Giraffe", "Cat"], ans: 2, isStory: true },
                        { q: "What is the past tense of 'Run'?", options: ["Runned", "Running", "Ran", "Runs"], ans: 2 },
                        { q: "Find the Adjective: 'The big red car.'", options: ["Car", "The", "Red", "Is"], ans: 2 },
                        { q: "'They _____ playing football yesterday.'", options: ["was", "were", "are", "is"], ans: 1 },
                        { q: "Which word is a noun (thing)?", options: ["Quickly", "Sing", "School", "Hot"], ans: 2 },
                        { q: "Choose the opposite of 'Happy'.", options: ["Glad", "Sad", "Fun", "Play"], ans: 1 },
                        { q: "'I _____ to the park.' (Present Continuous)", options: ["am going", "go", "gone", "went"], ans: 0 },
                        { q: "Which word is spelled correctly?", options: ["Freind", "Friend", "Frend", "Frind"], ans: 1 },
                        { q: "A person who flies a plane is a:", options: ["Driver", "Pilot", "Chef", "Teacher"], ans: 1 },
                        { q: "I like ice cream _____ cake.", options: ["and", "but", "so", "because"], ans: 0 },
                        { q: "Yesterday, I _____ an apple.", options: ["eat", "eats", "ate", "eating"], ans: 2 }
                    ],
                    writingPrompt: "Write about your favorite animal.",
                    readingPrompt: "Read aloud: 'The elephant has a long trunk. It likes to eat peanuts.'",
                    speakingQuestions: [
                        "Tell me about your family.",
                        "What is your favorite animal and why?",
                        "What did you do yesterday?"
                    ]
                },
                "Math": [
                    { q: "What is 100 + 50?", options: ["105", "150", "500", "115"], ans: 1 },
                    { q: "How many minutes are in one hour?", options: ["30", "100", "60", "24"], ans: 2 },
                    { q: "What is 3 x 5?", options: ["8", "12", "15", "10"], ans: 2 },
                    { q: "Which number is Even?", options: ["3", "7", "8", "11"], ans: 2 },
                    { q: "Bob has 20 candies. He gives away 5. How many are left?", options: ["10", "15", "25", "12"], ans: 1 },
                    { q: "What comes next? 2, 4, 6, 8, __", options: ["9", "10", "12", "11"], ans: 1 },
                    { q: "How many sides does a rectangle have?", options: ["3", "4", "5", "6"], ans: 1 },
                    { q: "What is half of 10?", options: ["2", "5", "4", "6"], ans: 1 },
                    { q: "50 - 25 = ?", options: ["20", "25", "30", "15"], ans: 1 },
                    { q: "2 x 10 = ?", options: ["12", "20", "22", "10"], ans: 1 }
                ],
                "Science": [
                    { q: "The sun gives us light and ______?", options: ["Water", "Heat", "Rain", "Sound"], ans: 1 },
                    { q: "Which material is waterproof?", options: ["Paper", "Plastic", "Tissue", "Sponge"], ans: 1 },
                    { q: "A baby frog is called a:", options: ["Puppy", "Kitten", "Tadpole", "Calf"], ans: 2 },
                    { q: "Which food is healthy?", options: ["Chips", "Apple", "Soda", "Cake"], ans: 1 },
                    { q: "Shadows are made when light is:", options: ["Blocked", "Hot", "Bright", "Fast"], ans: 0 },
                    { q: "Which animal lives in a hive?", options: ["Dog", "Bee", "Bird", "Cat"], ans: 1 },
                    { q: "Paper is made from:", options: ["Plastic", "Wood (Trees)", "Metal", "Sand"], ans: 1 },
                    { q: "To grow, a plant needs water and:", options: ["Sugar", "Sunlight", "Juice", "Milk"], ans: 1 }
                ]
            },
            "P3": {
                "English": {
                    story: "Every morning, Jack wakes up at 6 AM when his alarm rings. First, he brushes his teeth until they are clean. Then, he eats a healthy breakfast of toast and eggs. Finally, he walks to school with his best friends.",
                    questions: [
                        { q: "When does Jack wake up?", options: ["7 AM", "6 AM", "8 AM", "5 AM"], ans: 1, isStory: true },
                        { q: "What does Jack eat?", options: ["Toast and eggs", "Pizza", "Rice", "Soup"], ans: 0, isStory: true },
                        { q: "How does he go to school?", options: ["By bus", "By car", "He walks", "He runs"], ans: 2, isStory: true },
                        { q: "Which sentence uses a comma correctly?", options: ["I like, apples", "I like apples, bananas, and pears.", "I like apples bananas,", "I, like apples"], ans: 1 },
                        { q: "Choose the adverb: 'She sings loudly.'", options: ["She", "Sings", "Loudly", "Song"], ans: 2 },
                        { q: "What is the opposite of 'Create'?", options: ["Build", "Destroy", "Make", "Draw"], ans: 1 },
                        { q: "'I _____ to the shop tomorrow.'", options: ["went", "will go", "gone", "going"], ans: 1 },
                        { q: "Which word is spelled correctly?", options: ["Becuse", "Becuase", "Because", "Beacuse"], ans: 2 },
                        { q: "'The children _____ happy with their toys.'", options: ["was", "were", "is", "be"], ans: 1 },
                        { q: "What is a 'Biography'?", options: ["Dragon story", "Story about a person's life", "Poem", "Recipe"], ans: 1 },
                        { q: "Choose the correct pronoun: 'Tom is my friend. _____ is nice.'", options: ["She", "He", "It", "They"], ans: 1 },
                        { q: "She is taller _____ her brother.", options: ["then", "than", "that", "this"], ans: 1 },
                        { q: "We _____ playing football now.", options: ["is", "am", "are", "be"], ans: 2 }
                    ],
                    writingPrompt: "Describe your morning routine.",
                    readingPrompt: "Read aloud: 'We walk to school every morning. The sun is shining bright today. My friends are walking with me.'",
                    speakingQuestions: [
                        "What do you do in the morning before school?",
                        "What is your favorite subject and why?",
                        "Describe your best friend."
                    ]
                },
                "Math": [
                    { q: "What is 24 divided by 4?", options: ["5", "6", "8", "12"], ans: 1 },
                    { q: "Write the number: Three hundred and fifty-two.", options: ["352", "30052", "325", "532"], ans: 0 },
                    { q: "What is half of 50?", options: ["20", "25", "30", "15"], ans: 1 },
                    { q: "What is 120 - 45?", options: ["85", "75", "65", "80"], ans: 1 },
                    { q: "How many cm in 1 meter?", options: ["10", "100", "1000", "50"], ans: 1 },
                    { q: "9 x 9 = ?", options: ["18", "81", "99", "72"], ans: 1 },
                    { q: "What is 1/4 of 20?", options: ["4", "5", "10", "2"], ans: 1 },
                    { q: "A square has 4 sides. How many sides do 2 squares have?", options: ["6", "8", "10", "12"], ans: 1 },
                    { q: "200 + 300 + 50 = ?", options: ["530", "550", "2350", "505"], ans: 1 },
                    { q: "Which month comes after June?", options: ["May", "August", "July", "April"], ans: 2 }
                ],
                "Science": [
                    { q: "What part of the plant absorbs water?", options: ["Leaves", "Flower", "Roots", "Stem"], ans: 2 },
                    { q: "Which animal lays eggs?", options: ["Dog", "Cat", "Chicken", "Cow"], ans: 2 },
                    { q: "Magnets attract which metal?", options: ["Gold", "Iron", "Aluminum", "Copper"], ans: 1 },
                    { q: "What do lungs help us do?", options: ["Eat", "Breathe", "Think", "Walk"], ans: 1 },
                    { q: "Solids, Liquids, and _____ are states of matter.", options: ["Water", "Ice", "Gas", "Air"], ans: 2 },
                    { q: "Which animal is a reptile?", options: ["Frog", "Snake", "Eagle", "Bear"], ans: 1 },
                    { q: "Friction makes moving things:", options: ["Go faster", "Slow down", "Fly", "Bounce"], ans: 1 },
                    { q: "Sound is caused by:", options: ["Vibrations", "Light", "Heat", "Water"], ans: 0 }
                ]
            },
            "P4": {
                "English": {
                    story: "Football is a very popular sport all over the world. To be a good player, you need to be fast, strong, and smart. Players practice every single day to improve their skills. Most importantly, they must learn to work together as a team to win the game.",
                    questions: [
                        { q: "What do players need?", options: ["Sleepy", "Fast and strong", "Quiet", "Loud"], ans: 1, isStory: true },
                        { q: "How often do they practice?", options: ["Every week", "Every day", "Every month", "Never"], ans: 1, isStory: true },
                        { q: "What is most important to win?", options: ["Running fast", "Being strong", "Working together", "Buying new shoes"], ans: 2, isStory: true },
                        { q: "'I haven't seen him _____ last week.'", options: ["for", "since", "from", "by"], ans: 1 },
                        { q: "Which word is a synonym for 'Happy'?", options: ["Sad", "Angry", "Joyful", "Tired"], ans: 2 },
                        { q: "Subject: 'The teacher gave the students a test.'", options: ["The teacher", "Gave", "A test", "The students"], ans: 0 },
                        { q: "'He is the _____ boy in the class.'", options: ["tall", "taller", "tallest", "most tall"], ans: 2 },
                        { q: "Choose the correct homophone: 'I can _____ the ocean.'", options: ["sea", "see", "saw", "seen"], ans: 1 },
                        { q: "'The car was driven _____ my father.'", options: ["with", "by", "from", "at"], ans: 1 },
                        { q: "Which word is a conjunction?", options: ["Because", "House", "Run", "Slowly"], ans: 0 },
                        { q: "'I am interested _____ learning math.'", options: ["on", "in", "at", "for"], ans: 1 },
                        { q: "The movie was very _____.", options: ["excite", "excited", "exciting", "excites"], ans: 2 },
                        { q: "We ate dinner _____ we watched TV.", options: ["before", "during", "so", "but"], ans: 0 }
                    ],
                    writingPrompt: "What is your favorite sport?",
                    readingPrompt: "Read aloud: 'Teamwork is very important in sports. Players must help each other to win. Practice makes the team get better daily. Everyone is happy when they score a goal.'",
                    speakingQuestions: [
                        "What sport or game do you like to play?",
                        "Why is teamwork important?",
                        "Tell me about a time you helped someone."
                    ]
                },
                "Math": [
                    { q: "What is 7 x 8?", options: ["54", "56", "48", "64"], ans: 1 },
                    { q: "Perimeter of square with side 5cm?", options: ["10cm", "20cm", "25cm", "15cm"], ans: 1 },
                    { q: "Which fraction is the same as 0.5?", options: ["1/4", "1/2", "3/4", "1/10"], ans: 1 },
                    { q: "Round 456 to the nearest 100.", options: ["400", "450", "460", "500"], ans: 3 },
                    { q: "What is 15.5 + 4.5?", options: ["19.0", "20.0", "20.5", "19.5"], ans: 1 },
                    { q: "120 divided by 10 = ?", options: ["10", "12", "1200", "20"], ans: 1 },
                    { q: "Which angle is 90 degrees?", options: ["Acute", "Right Angle", "Obtuse", "Straight"], ans: 1 },
                    { q: "Value of digit 4 in 4,520?", options: ["4", "4000", "400", "40"], ans: 1 },
                    { q: "What is 1/3 of 15?", options: ["3", "5", "6", "10"], ans: 1 },
                    { q: "25 x 4 = ?", options: ["50", "75", "100", "125"], ans: 2 }
                ],
                "Science": [
                    { q: "What happens when water freezes?", options: ["Gas", "Solid (Ice)", "Disappears", "Hot"], ans: 1 },
                    { q: "Which one conducts electricity?", options: ["Wood", "Metal", "Plastic", "Rubber"], ans: 1 },
                    { q: "The process where water turns into vapor is:", options: ["Condensation", "Evaporation", "Precipitation", "Melting"], ans: 1 },
                    { q: "Sound travels fastest through:", options: ["Air", "Water", "Solids", "Vacuum"], ans: 2 },
                    { q: "Which animal is a predator?", options: ["Rabbit", "Lion", "Deer", "Mouse"], ans: 1 },
                    { q: "Which planet is closest to the Sun?", options: ["Earth", "Mercury", "Jupiter", "Mars"], ans: 1 },
                    { q: "A circuit needs a power source, like a:", options: ["Battery", "Bulb", "Wire", "Switch"], ans: 0 },
                    { q: "Teeth are used for:", options: ["Breathing", "Digestion (Chewing)", "Circulation", "Thinking"], ans: 1 }
                ]
            },
            "P5": {
                "English": {
                    story: "The solar system is a fascinating place with eight unique planets orbiting the Sun. Mercury is the closest planet to the Sun, but Venus is actually the hottest because of its thick clouds. Earth is special because it is the only planet known to have water and support life.",
                    questions: [
                        { q: "Which planet is hottest?", options: ["Mercury", "Earth", "Mars", "Venus"], ans: 3, isStory: true },
                        { q: "How many planets are there?", options: ["7", "8", "9", "10"], ans: 1, isStory: true },
                        { q: "Why is Earth special?", options: ["It is hot", "It has rings", "It has life", "It is small"], ans: 2, isStory: true },
                        { q: "'If I had known, I _____ called you.'", options: ["will have", "would have", "can have", "shall have"], ans: 1 },
                        { q: "Choose the correct spelling.", options: ["Neccessary", "Necessary", "Neccesary", "Necessery"], ans: 1 },
                        { q: "'The book was written _____ JK Rowling.'", options: ["from", "by", "with", "of"], ans: 1 },
                        { q: "Choose the prefix to make 'Agree' negative.", options: ["Un-", "Dis-", "Mis-", "Im-"], ans: 1 },
                        { q: "Which sentence is in the Passive Voice?", options: ["The cat ate food", "The food was eaten by the cat", "Cat is eating", "Cat will eat"], ans: 1 },
                        { q: "'She accused him _____ stealing the money.'", options: ["of", "for", "with", "on"], ans: 0 },
                        { q: "Identify the preposition: 'The cat jumped over the fence.'", options: ["Jumped", "Over", "Cat", "Fence"], ans: 1 },
                        { q: "'Neither John _____ Mary came to the party.'", options: ["or", "nor", "and", "but"], ans: 1 },
                        { q: "He said he _____ hungry.", options: ["is", "was", "were", "are"], ans: 1 },
                        { q: "I look forward to _____ you.", options: ["see", "saw", "seen", "seeing"], ans: 3 }
                    ],
                    writingPrompt: "Write a fact about space.",
                    readingPrompt: "Read aloud: 'Earth is the only planet known to have life. It has vast oceans and green forests. We must protect our environment from pollution. Recycling plastic helps keep our world clean. Let us work together to save the planet.'",
                    speakingQuestions: [
                        "If you could travel to space, where would you go?",
                        "Why is it important to learn about science?",
                        "Describe your favorite book or movie."
                    ]
                },
                "Math": [
                    { q: "What is 12 squared?", options: ["24", "144", "120", "100"], ans: 1 },
                    { q: "Solve for x: 2x + 4 = 14", options: ["10", "5", "7", "2"], ans: 1 },
                    { q: "Area of a rectangle with length 6m and width 4m.", options: ["10m¬≤", "24m¬≤", "20m¬≤", "12m¬≤"], ans: 1 },
                    { q: "Simplify the fraction: 8/12", options: ["4/6", "2/3", "3/4", "1/2"], ans: 1 },
                    { q: "What is 10% of 500?", options: ["10", "50", "100", "5"], ans: 1 },
                    { q: "LCM of 4 and 6?", options: ["24", "12", "10", "2"], ans: 1 },
                    { q: "Convert 0.75 to a percentage.", options: ["7.5%", "75%", "0.75%", "750%"], ans: 1 },
                    { q: "How many degrees are in a triangle?", options: ["90", "180", "360", "100"], ans: 1 },
                    { q: "0.5 + 0.25 = ?", options: ["0.30", "0.75", "0.80", "0.55"], ans: 1 },
                    { q: "Which number is prime?", options: ["4", "9", "7", "10"], ans: 2 }
                ],
                "Science": [
                    { q: "Which force pulls objects to Earth?", options: ["Friction", "Magnetism", "Gravity", "Tension"], ans: 2 },
                    { q: "The Earth orbits around the ______?", options: ["Moon", "Sun", "Mars", "Stars"], ans: 1 },
                    { q: "Which organ pumps blood?", options: ["Brain", "Lungs", "Heart", "Stomach"], ans: 2 },
                    { q: "Light travels in:", options: ["Curved lines", "Straight lines", "Zigzags", "Circles"], ans: 1 },
                    { q: "Photosynthesis requires sunlight, water, and:", options: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Sugar"], ans: 1 },
                    { q: "Which part of the cell controls its activity?", options: ["Cell Wall", "Nucleus", "Cytoplasm", "Membrane"], ans: 1 },
                    { q: "When light bounces off a mirror, it is called:", options: ["Refraction", "Reflection", "Absorption", "Dispersion"], ans: 1 },
                    { q: "What protects the brain?", options: ["Ribcage", "Skull", "Spine", "Pelvis"], ans: 1 }
                ]
            },
            "P6": {
                "English": {
                    story: "Climate change is one of the most serious issues facing our world today. It is largely caused by the increase of greenhouse gases like carbon dioxide in the atmosphere, which trap heat. To help fix this problem, people can reduce waste, use renewable energy like solar power, and plant more trees to clean the air.",
                    questions: [
                        { q: "What causes climate change?", options: ["Trees", "Recycling", "Greenhouse gases", "Energy"], ans: 2, isStory: true },
                        { q: "What traps the heat?", options: ["Greenhouse gases", "Water", "Trees", "Wind"], ans: 0, isStory: true },
                        { q: "How can people help?", options: ["Use more plastic", "Plant trees", "Drive more cars", "Burn trash"], ans: 1, isStory: true },
                        { q: "'If it rains, we _____ inside.'", options: ["Stay", "Will stay", "Would stay", "Stayed"], ans: 1 },
                        { q: "'He asked me where _____ going.'", options: ["was I", "I was", "am I", "I am"], ans: 1 },
                        { q: "What does 'Optimistic' mean?", options: ["Sad", "Hopeful/Positive", "Angry", "Confused"], ans: 1 },
                        { q: "Which of these is a metaphor?", options: ["Brave as a lion", "Time is a thief", "Leaves danced", "Snap, crackle, pop"], ans: 1 },
                        { q: "Identify the conjunction: 'I wanted to go, but I was tired.'", options: ["Wanted", "But", "Was", "Tired"], ans: 1 },
                        { q: "'The manager, _____ I spoke to, was very helpful.'", options: ["who", "whom", "which", "that"], ans: 1 },
                        { q: "'She is used to _____ early.'", options: ["wake up", "waking up", "woke up", "wakes up"], ans: 1 },
                        { q: "Choose the correct synonym for 'Difficult'.", options: ["Facile", "Arduous", "Simple", "Plain"], ans: 1 },
                        { q: "He denied _____ the money.", options: ["steal", "to steal", "stealing", "stole"], ans: 2 },
                        { q: "I wish I _____ richer.", options: ["am", "was", "were", "be"], ans: 2 }
                    ],
                    writingPrompt: "Why should we protect nature?",
                    readingPrompt: "Read aloud: 'Renewable energy helps reduce pollution in our cities. Solar power comes from the bright sun above. Wind turbines use the wind to make electricity. These clean sources do not harm the air. We must use energy wisely to help nature. A clean planet is a healthy place for us.'",
                    speakingQuestions: [
                        "What do you think is the biggest problem in the world today?",
                        "How can we help the environment?",
                        "What are your goals for the future?"
                    ]
                },
                "Math": [
                    { q: "Calculate 3 + 4 x 5", options: ["35", "23", "20", "60"], ans: 1 },
                    { q: "What is the value of Pi roughly?", options: ["3.00", "3.14", "3.41", "2.14"], ans: 1 },
                    { q: "What is the sum of angles in a triangle?", options: ["90", "180", "360", "100"], ans: 1 },
                    { q: "If 3x = 15, what is x?", options: ["3", "5", "12", "45"], ans: 1 },
                    { q: "Convert 1.5kg to grams.", options: ["150g", "1500g", "15000g", "1050g"], ans: 1 },
                    { q: "Probability of flipping a coin and getting Heads?", options: ["1/4", "1/2", "1/3", "1/1"], ans: 1 },
                    { q: "Solve: -5 + 8 = ?", options: ["-3", "3", "-13", "13"], ans: 1 },
                    { q: "Calculate the volume of a cube with side 3cm.", options: ["9cm¬≥", "27cm¬≥", "18cm¬≥", "12cm¬≥"], ans: 1 },
                    { q: "25% of 200 is:", options: ["25", "50", "75", "100"], ans: 1 },
                    { q: "Square root of 64?", options: ["6", "7", "8", "9"], ans: 2 }
                ],
                "Science": [
                    { q: "What is the chemical symbol for Oxygen?", options: ["Ox", "O2", "H2O", "Co2"], ans: 1 },
                    { q: "Which energy comes from the sun?", options: ["Kinetic", "Solar", "Potential", "Chemical"], ans: 1 },
                    { q: "In a food chain, what eats a producer?", options: ["Carnivore", "Herbivore", "Decomposer", "Predator"], ans: 1 },
                    { q: "An object in motion stays in motion unless acted on by a force. This is:", options: ["Gravity", "Inertia", "Friction", "Speed"], ans: 1 },
                    { q: "Acid turns litmus paper:", options: ["Blue", "Red", "Green", "Yellow"], ans: 1 },
                    { q: "Which planet has rings?", options: ["Mars", "Saturn", "Venus", "Mercury"], ans: 1 },
                    { q: "Water boils at:", options: ["50¬∞C", "100¬∞C", "90¬∞C", "120¬∞C"], ans: 1 },
                    { q: "What carries oxygen in our blood?", options: ["White blood cells", "Red blood cells", "Platelets", "Plasma"], ans: 1 }
                ]
            }
        };

        // --- VARIABLES ---
        let currentLevel = "";
        let flatQuestions = [];
        let currentQIndex = 0;

        // Scores
        let scores = { English: 0, Math: 0, Science: 0 };
        let maxScores = { English: 0, Math: 0, Science: 0 };

        // Assessor scores for English sub-components
        let englishComponents = {
            mcqScore: 0,
            mcqMax: 0,
            readingScorePct: 0, // Percentage
            writingScorePct: 0,  // Percentage
            speakingScorePct: 0 // Percentage
        };

        let selectedOption = null;
        let studentName = "";
        let assessorName = "";
        let selectedCampus = "";
        let studentWriting = ""; // Capture student text

        function init() {
            const btnContainer = document.getElementById("level-buttons");
            Object.keys(quizData).forEach(level => {
                let btn = document.createElement("button");
                btn.className = "btn";
                btn.innerText = level;
                btn.onclick = () => startQuiz(level);
                btnContainer.appendChild(btn);
            });
        }

        // New Function to handle Registration
        function goToLevelSelection() {
            const sName = document.getElementById("student-name").value;
            const aName = document.getElementById("assessor-name").value;
            const campus = document.getElementById("campus-select").value;
            const errorDiv = document.getElementById('error-msg');

            if (sName.trim() === "" || aName.trim() === "" || campus === "") {
                errorDiv.innerText = "Please fill in all candidate details.";
                errorDiv.style.display = "block";
                return;
            }

            errorDiv.style.display = "none";
            studentName = sName;
            assessorName = aName;
            selectedCampus = campus;

            // Update display on next screen
            document.getElementById("display-student-name").innerText = studentName;

            document.getElementById("registration-screen").classList.remove("active");
            document.getElementById("level-screen").classList.add("active");
        }

        function startQuiz(level) {
            currentLevel = level;
            flatQuestions = [];
            scores = { English: 0, Math: 0, Science: 0 };
            maxScores = { English: 0, Math: 0, Science: 0 };
            englishComponents = { mcqScore: 0, mcqMax: 0, readingScorePct: 0, writingScorePct: 0, speakingScorePct: 0 };
            currentQIndex = 0;
            studentWriting = "";

            // Reset Text Area
            document.getElementById("writing-input").value = "";

            // Build flat array
            // 1. English MCQs
            if (quizData[level]["English"]) {
                const engData = quizData[level]["English"];
                engData.questions.forEach(q => {
                    flatQuestions.push({ ...q, subject: "English", type: "mcq", isStory: q.isStory });
                    maxScores["English"]++;
                    englishComponents.mcqMax++;
                });
                // Add Reading Task (Assessor Graded)
                flatQuestions.push({
                    subject: "English",
                    type: "assessor_grade",
                    subType: "Reading",
                    prompt: engData.readingPrompt
                });
                // Add Writing Task (Student Types + Assessor Graded)
                flatQuestions.push({
                    subject: "English",
                    type: "assessor_grade",
                    subType: "Writing",
                    prompt: engData.writingPrompt
                });
                // NEW: Add Speaking Task (Assessor Graded)
                flatQuestions.push({
                    subject: "English",
                    type: "speaking_task",
                    subType: "Speaking",
                    questions: engData.speakingQuestions || ["Default Q1", "Default Q2", "Default Q3"]
                });
            }

            // 2. Math
            if (quizData[level]["Math"]) {
                quizData[level]["Math"].forEach(q => {
                    flatQuestions.push({ ...q, subject: "Math", type: "mcq" });
                    maxScores["Math"]++;
                });
            }

            // 3. Science
            if (quizData[level]["Science"]) {
                quizData[level]["Science"].forEach(q => {
                    flatQuestions.push({ ...q, subject: "Science", type: "mcq" });
                    maxScores["Science"]++;
                });
            }

            document.getElementById("level-screen").classList.remove("active");
            document.getElementById("quiz-screen").classList.add("active");
            loadQuestion();
        }

        // Function to read the question text
        function speakQuestionText() {
            // Use prompt text if available (for Reading/Writing), otherwise question text
            let text = "";
            const promptDisplay = document.getElementById("prompt-display");
            const speakingDisplay = document.getElementById("speaking-display");

            if (promptDisplay.style.display !== "none") {
                text = promptDisplay.innerText.replace("Task: ", "");
            } else if (speakingDisplay.style.display !== "none") {
                // For speaking, read the instruction
                text = "Please answer these questions. " + speakingDisplay.innerText;
            } else {
                text = document.getElementById("question-text").innerText;
            }

            // Remove emojis safely
            // Replaces emojis with the word "picture" for audio
            let safeText = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, " picture ");

            // Convert underscores to "blank" to avoid spelling it out
            safeText = safeText.replace(/_+/g, " blank ");

            const utterance = new SpeechSynthesisUtterance(safeText);
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        // Function for the Story Button
        function playListeningStory() {
            const story = quizData[currentLevel]["English"]?.story;
            if (story) {
                const utterance = new SpeechSynthesisUtterance(story);
                utterance.rate = 0.85;
                window.speechSynthesis.speak(utterance);
            }
        }

        function loadQuestion() {
            if (currentQIndex >= flatQuestions.length) {
                showResults();
                return;
            }

            const qData = flatQuestions[currentQIndex];

            // Reset UI elements
            document.getElementById("options-container").style.display = "none";
            document.getElementById("assessor-grading-container").style.display = "none";
            document.getElementById("writing-container").style.display = "none";
            document.getElementById("next-btn").style.display = "none";
            document.getElementById("btn-listen-story").style.display = "none"; // Hide Story Button
            document.getElementById("prompt-display").style.display = "none";
            document.getElementById("speaking-display").style.display = "none"; // Hide Speaking list

            document.getElementById("subject-badge").innerText = qData.subject + " - " + "Step " + (currentQIndex + 1) + " of " + flatQuestions.length;

            // --- 1. Assessor Grading Task (Reading/Writing) ---
            if (qData.type === "assessor_grade") {
                document.getElementById("question-text").innerText = "ASSESSOR GRADING: " + qData.subType;
                document.getElementById("question-text").style.color = "#e53935";

                document.getElementById("prompt-display").innerText = "Task: " + qData.prompt;
                document.getElementById("prompt-display").style.display = "block";

                if (qData.subType === "Writing") {
                    document.getElementById("writing-container").style.display = "block";
                }

                document.getElementById("assessor-grading-container").style.display = "grid";

                // --- 2. Speaking Task ---
            } else if (qData.type === "speaking_task") {
                document.getElementById("question-text").innerText = "ASSESSOR GRADING: Speaking";
                document.getElementById("question-text").style.color = "#e53935";

                // Build list of questions
                const listEl = document.getElementById("speaking-display");
                listEl.innerHTML = "";
                qData.questions.forEach(q => {
                    const li = document.createElement("li");
                    li.innerText = q;
                    listEl.appendChild(li);
                });
                listEl.style.display = "block";

                document.getElementById("assessor-grading-container").style.display = "grid";

                // --- 3. Standard MCQ ---
            } else {
                document.getElementById("question-text").innerText = qData.q;
                document.getElementById("question-text").style.color = "var(--primary)";
                document.getElementById("options-container").style.display = "block";

                // LOGIC: Show Listen Story button ONLY if isStory is true
                if (qData.subject === "English" && qData.isStory === true) {
                    document.getElementById("btn-listen-story").style.display = "inline-flex";
                }

                const optContainer = document.getElementById("options-container");
                optContainer.innerHTML = "";
                selectedOption = null;

                qData.options.forEach((opt, idx) => {
                    let btn = document.createElement("button");
                    btn.className = "btn-option";
                    btn.innerText = opt;
                    btn.onclick = () => selectOption(idx, btn);
                    optContainer.appendChild(btn);
                });
            }

            const pct = ((currentQIndex) / flatQuestions.length) * 100;
            document.getElementById("progress-bar").style.width = pct + "%";
        }

        // Audio stop logic
        // 1. Stop audio when moving to next question
        function nextQuestion() {
            window.speechSynthesis.cancel();

            const qData = flatQuestions[currentQIndex];
            if (qData.type === "mcq" && selectedOption === qData.ans) {
                scores[qData.subject]++;
                if (qData.subject === "English") {
                    englishComponents.mcqScore++;
                }
            }
            currentQIndex++;
            loadQuestion();
        }

        // 2. Stop audio on refresh or page close
        window.addEventListener('beforeunload', function () {
            window.speechSynthesis.cancel();
        });

        function selectOption(index, btnElement) {
            selectedOption = index;
            document.querySelectorAll(".btn-option").forEach(b => b.classList.remove("selected"));
            btnElement.classList.add("selected");
            document.getElementById("next-btn").style.display = "inline-block";
        }

        // Function called by Assessor Buttons
        function gradeAssessorTask(scorePercentage) {
            window.speechSynthesis.cancel(); // Also stop audio when assessor grades

            const qData = flatQuestions[currentQIndex];

            if (qData.subType === "Reading") {
                englishComponents.readingScorePct = scorePercentage;
            } else if (qData.subType === "Writing") {
                englishComponents.writingScorePct = scorePercentage;
                const inputVal = document.getElementById("writing-input").value;
                if (inputVal) studentWriting = inputVal;
            } else if (qData.subType === "Speaking") {
                englishComponents.speakingScorePct = scorePercentage;
            }

            currentQIndex++;
            loadQuestion();
        }

        function showResults() {
            document.getElementById("quiz-screen").classList.remove("active");
            document.getElementById("result-screen").classList.add("active");

            // Populate Date correctly
            // Force Cambodian format: [Day of Week], [DD]-[Month]-[YYYY]
            const now = new Date();
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const formattedDate = `${days[now.getDay()]}, ${now.getDate()}-${months[now.getMonth()]}-${now.getFullYear()}`;

            // Fix: Ensure element exists before setting innerText
            const dateElement = document.getElementById("res-date");
            if (dateElement) {
                dateElement.innerText = formattedDate;
            }

            // Fill Details on Screen
            document.getElementById("res-student").innerText = studentName;
            document.getElementById("res-assessor").innerText = assessorName;
            document.getElementById("res-campus").innerText = selectedCampus;
            document.getElementById("res-level").innerText = currentLevel;

            // --- Calculate English Score (Weighted Average: 25% each) ---
            let engMcqPct = (englishComponents.mcqScore / englishComponents.mcqMax) * 100 || 0;
            let finalEngPct = (engMcqPct * 0.25) +
                (englishComponents.readingScorePct * 0.25) +
                (englishComponents.writingScorePct * 0.25) +
                (englishComponents.speakingScorePct * 0.25);

            let mathPct = (scores.Math / maxScores.Math) * 100 || 0;
            let sciPct = (scores.Science / maxScores.Science) * 100 || 0;

            let weightedScore = (finalEngPct * 0.50) + (mathPct * 0.30) + (sciPct * 0.20);
            weightedScore = Math.round(weightedScore);

            document.getElementById("score-eng").innerText = Math.round(finalEngPct);
            // Update Breakdown
            document.getElementById("score-eng-mcq").innerText = Math.round(engMcqPct);
            document.getElementById("score-eng-read").innerText = Math.round(englishComponents.readingScorePct);
            document.getElementById("score-eng-write").innerText = Math.round(englishComponents.writingScorePct);
            document.getElementById("score-eng-speak").innerText = Math.round(englishComponents.speakingScorePct);

            document.getElementById("score-math").innerText = Math.round(mathPct);
            document.getElementById("score-sci").innerText = Math.round(sciPct);
            document.getElementById("final-score").innerText = weightedScore;

            const verdict = document.getElementById("final-verdict");
            const statusText = weightedScore >= 60 ? "PASSED" : "REVIEW NEEDED";

            if (weightedScore >= 60) {
                verdict.innerHTML = "<h2 class='pass'>PASSED ‚úÖ</h2><p>Excellent! The student is ready for " + currentLevel + ".</p>";
            } else {
                verdict.innerHTML = "<h2 class='fail'>REVIEW NEEDED ‚ö†Ô∏è</h2><p>The student may need support in English or core subjects.</p>";
            }

            // --- WEBHOOK INTEGRATION ---
            const payload = {
                student_name: studentName,
                assessor_name: assessorName,
                campus: selectedCampus,
                level_applied: currentLevel,
                date: formattedDate,
                scores: {
                    english: Math.round(finalEngPct),
                    english_details: {
                        mcq: Math.round(engMcqPct),
                        reading: Math.round(englishComponents.readingScorePct),
                        writing: Math.round(englishComponents.writingScorePct),
                        speaking: Math.round(englishComponents.speakingScorePct)
                    },
                    math: Math.round(mathPct),
                    science: Math.round(sciPct)
                },
                writing_response: studentWriting,
                final_score: weightedScore,
                result: statusText
            };

            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerText = "Syncing data to cloud...";
            statusDiv.style.color = "var(--primary)";

            // Use no-cors mode to bypass browser security restrictions
            // Content-Type header removed to ensure the request is treated as a "Simple Request"
            fetch("https://calixtojohnn.app.n8n.cloud/webhook/4cecec6e-b2f2-46c1-98fc-b3b11ccf3932", {
                method: "POST",
                mode: "no-cors",
                headers: {
                    "Content-Type": "text/plain"
                },
                body: JSON.stringify(payload)
            })
                .then(() => {
                    statusDiv.innerText = "‚úÖ Data synced successfully.";
                    statusDiv.style.color = "var(--success)";
                })
                .catch(error => {
                    console.warn("Webhook Sync Issue:", error);
                    statusDiv.innerText = "‚ö†Ô∏è Could not sync data. Please screenshot results.";
                    statusDiv.style.color = "var(--accent)";
                });
        }

        // --- PDF Download Logic (Updated to fix blank and shifting issues) ---
        function downloadPDF() {
            const element = document.getElementById('pdf-export-container');

            // Grab elements to hide so they don't interfere with the PDF capture
            const mainContainer = document.querySelector('.container');
            const sceneryWrapper = document.querySelector('.scenery-wrapper');

            const engPct = document.getElementById("score-eng").innerText;
            // Get Breakdown Values
            const engMcqPct = document.getElementById("score-eng-mcq").innerText;
            const engReadPct = document.getElementById("score-eng-read").innerText;
            const engWritePct = document.getElementById("score-eng-write").innerText;
            const engSpeakPct = document.getElementById("score-eng-speak").innerText;

            const mathPct = document.getElementById("score-math").innerText;
            const sciPct = document.getElementById("score-sci").innerText;
            const finalScore = document.getElementById("final-score").innerText;
            const date = document.getElementById("res-date").innerText;
            const verdictText = parseInt(finalScore) >= 60 ? "PASSED ‚úÖ" : "REVIEW NEEDED ‚ö†Ô∏è";

            // Dynamic Remark Text
            let verdictSubtitle = "";
            if (parseInt(finalScore) >= 60) {
                verdictSubtitle = "Excellent! The student is ready for " + currentLevel + ".";
            } else {
                verdictSubtitle = "The student may need support in English or core subjects.";
            }

            // Update Grid Values
            document.getElementById('pdf-student').innerText = studentName;
            document.getElementById('pdf-campus').innerText = selectedCampus;
            document.getElementById('pdf-date').innerText = date;
            document.getElementById('pdf-assessor').innerText = assessorName;

            // Update Scores
            document.getElementById('pdf-eng-score').innerText = engPct + "%";
            // Set Breakdown Values in PDF
            document.getElementById('pdf-eng-mcq').innerText = engMcqPct;
            document.getElementById('pdf-eng-read').innerText = engReadPct;
            document.getElementById('pdf-eng-write').innerText = engWritePct;
            document.getElementById('pdf-eng-speak').innerText = engSpeakPct;

            document.getElementById('pdf-math-score').innerText = mathPct + "%";
            document.getElementById('pdf-sci-score').innerText = sciPct + "%";
            document.getElementById('pdf-final-score').innerText = finalScore + "/100";

            // Update Verdict Box Content
            const verdictBox = document.getElementById('pdf-verdict-box');
            verdictBox.innerHTML = `
            <span class="pdf-verdict-title">${verdictText}</span>
            <span class="pdf-verdict-subtitle">${verdictSubtitle}</span>
        `;

            // Update styling based on Pass/Fail
            if (parseInt(finalScore) >= 60) {
                verdictBox.style.backgroundColor = "#e8f5e9"; // Light Green BG
                verdictBox.style.border = "2px solid #2e7d32";
                verdictBox.querySelector('.pdf-verdict-title').style.color = "#2e7d32";
            } else {
                verdictBox.style.backgroundColor = "#ffebee"; // Light Red BG
                verdictBox.style.border = "2px solid #e53935";
                verdictBox.querySelector('.pdf-verdict-title').style.color = "#e53935";
            }

            // The fix for the blank and shifted PDF on GitHub:
            // Hide the main UI and Background, and disable flexbox temporarily
            if (sceneryWrapper) sceneryWrapper.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'none';

            const originalBodyDisplay = document.body.style.display;
            document.body.style.display = 'block'; // Stops flexbox from centering the hidden container

            element.style.display = 'block';
            window.scrollTo(0, 0); // Guarantee we capture from coordinate 0,0

            const opt = {
                margin: 0, // 0 margin for edge-to-edge
                filename: `Result_${studentName.replace(/\s+/g, '_')}_${currentLevel}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1.5, scrollY: 0, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Restore everything after download completes
                element.style.display = 'none';
                document.body.style.display = originalBodyDisplay;
                if (mainContainer) mainContainer.style.display = 'block';
                if (sceneryWrapper) sceneryWrapper.style.display = 'block';
            }).catch(err => {
                console.error("PDF Failed:", err);
                alert("PDF Download Failed. Please check the console for details.");

                // Restore everything if it fails
                element.style.display = 'none';
                document.body.style.display = originalBodyDisplay;
                if (mainContainer) mainContainer.style.display = 'block';
                if (sceneryWrapper) sceneryWrapper.style.display = 'block';
            });
        }

        init();
    </script>
</body>

</html>
