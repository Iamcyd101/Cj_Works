<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Bridge International Academy - Placement Test</title>
    <!-- Import html2pdf library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            /* Updated Theme: Deep Teal & Gold */
            --primary: #004F63; /* Deep Teal */
            --secondary: #ffca28; /* Academic Gold */
            --accent: #e53935; /* Alert Red */
            --success: #2e7d32; /* Success Green */
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card);
            width: 95%;
            max-width: 800px;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border-top: 8px solid var(--primary);
        }

        .logo-area {
            margin-bottom: 20px;
        }
        .logo-area img {
            max-height: 100px; /* Adjust based on your actual logo size */
            width: auto;
        }

        h1 { color: var(--primary); margin-bottom: 5px; font-weight: 700; }
        h2 { color: #555; font-size: 1.1rem; margin-top: 0; font-weight: 400; }
        p { color: var(--text); line-height: 1.6; }

        /* Input Fields */
        .input-group {
            margin: 20px 0;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary);
        }
        .input-group input, 
        .input-group select,
        .input-group textarea { 
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box; 
            background-color: white;
            font-family: inherit;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Level Grid */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        /* Buttons */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover { background-color: #003644; transform: translateY(-2px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Audio Control Buttons */
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-speak {
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-speak:active { transform: scale(0.95); }
        
        /* Story Button Style */
        .btn-story {
            background-color: #ffca28; /* Gold */
            color: #333;
        }
        .btn-story:hover { background-color: #ffb300; }

        /* Question Read Button Style */
        .btn-read-q {
            background-color: #e0f2f1; /* Light Teal */
            color: #004F63;
            border: 1px solid #004F63;
        }
        .btn-read-q:hover { background-color: #b2dfdb; }

        .btn-option {
            display: block;
            width: 100%;
            background: white;
            color: var(--text);
            border: 2px solid #e0e0e0;
            margin: 10px 0;
            text-align: left;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.05rem;
        }
        .btn-option:hover { border-color: var(--secondary); background: #fffde7; }
        .btn-option.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Assessor Grading Buttons */
        .grading-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-grade {
            padding: 15px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: white;
            font-size: 0.9rem;
            transition: transform 0.1s;
        }
        .btn-grade:hover { transform: scale(1.02); }
        .grade-100 { background-color: #2e7d32; } /* Excellent */
        .grade-80 { background-color: #7cb342; }  /* Good */
        .grade-60 { background-color: #fdd835; color: #333; } /* Average */
        .grade-40 { background-color: #fb8c00; }  /* Below Average */
        .grade-20 { background-color: #e53935; }  /* Poor */
        .grade-0 { background-color: #424242; }   /* No Answer */

        /* Screens */
        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.4s ease-in-out; }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 25px;
            height: 8px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--secondary);
            width: 0%;
            transition: width 0.3s;
        }

        /* Results */
        .score-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: left;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
            color: #666;
        }
        .pass { color: var(--success); font-weight: bold; font-size: 1.4rem; }
        .fail { color: var(--accent); font-weight: bold; font-size: 1.4rem; }
        
        .subject-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            background: #e0f2f1;
            color: var(--primary);
            font-size: 0.85rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        #upload-status {
            font-size: 0.9rem;
            margin-top: 10px;
            font-weight: bold;
            color: #666;
        }

        /* --- MODERN PDF STYLES --- */
        #pdf-export-container {
            display: none;
            background: white;
            font-family: 'Segoe UI', sans-serif;
            color: #333;
            width: 800px;
            box-sizing: border-box;
            margin: 0 auto;
        }
        .pdf-header-bar {
            background-color: var(--primary);
            color: white;
            padding: 30px 40px;
            display: flex; 
            align-items: center;
            justify-content: flex-end; 
            border-bottom: 5px solid var(--secondary);
        }
        
        .pdf-title-wrapper {
            text-align: right;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .pdf-title-wrapper h1 { 
            color: white; 
            margin: 0; 
            font-size: 22px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        .pdf-title-wrapper p { 
            color: rgba(255,255,255,0.9); 
            margin: 5px 0 0; 
            font-size: 14px; 
        }

        .pdf-body {
            padding: 40px;
        }

        /* Modern Grid for Info */
        .pdf-info-grid {
            display: table;
            width: 100%;
            margin-bottom: 40px;
        }
        .pdf-info-row {
            display: table-row;
        }
        .pdf-info-cell {
            display: table-cell;
            width: 50%;
            padding-bottom: 20px;
            vertical-align: top;
        }
        .pdf-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            display: block;
            font-weight: 600;
        }
        .pdf-value {
            font-size: 18px;
            font-weight: bold;
            color: #222;
        }

        /* Modern Table */
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        .pdf-table th {
            text-align: left;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding: 12px 10px;
            font-size: 13px;
            text-transform: uppercase;
        }
        .pdf-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
            color: #444;
        }
        .pdf-table .total-row td {
            border-top: 2px solid var(--primary);
            border-bottom: none;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            padding-top: 20px;
        }

        /* Badge Verdict */
        .pdf-verdict-container {
            margin-top: 40px;
            text-align: center;
        }
        .pdf-verdict-badge {
            display: block;
            padding: 20px;
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }
        .pdf-verdict-title {
            font-size: 24px; 
            font-weight: bold; 
            color: var(--success);
            display: block;
            margin-bottom: 5px;
        }
        .pdf-verdict-subtitle {
            font-size: 16px;
            color: #555;
        }

        .pdf-footer {
            margin-top: 60px;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #aaa;
        }
        .signature-line {
            width: 200px;
            border-top: 1px solid #333;
            margin-top: 40px;
            padding-top: 5px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        
        .writing-review-box {
            border: 1px dashed #999;
            padding: 15px;
            margin-top: 20px;
            background-color: #f9f9f9;
            font-style: italic;
            font-size: 14px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-area">
        <!-- Main Screen Logo: Updated to new image -->
        <img src="image_53389d.png" id="main-logo" alt="Vision Bridge International Academy Logo" onerror="this.style.display='none'">
    </div>

    <!-- Screen 1: Registration -->
    <div id="registration-screen" class="screen active">
        <h1>Vision Bridge International Academy</h1>
        <h2>Digital Placement Test</h2>
        <p>Please enter the candidate and assessor details to begin.</p>
        
        <div class="input-group">
            <label for="student-name">Student Name:</label>
            <input type="text" id="student-name" placeholder="Enter Full Name" required>
        </div>
        <div class="input-group">
            <label for="assessor-name">Assessor Name:</label>
            <input type="text" id="assessor-name" placeholder="Enter Teacher/Assessor Name" required>
        </div>
        
        <!-- CAMPUS DROPDOWN -->
        <div class="input-group">
            <label for="campus-select">Campus:</label>
            <select id="campus-select" required>
                <option value="" disabled selected>-- Select Campus --</option>
                <option value="BKK Campus">BKK Campus</option>
                <option value="Sen Sok Campus">Sen Sok Campus</option>
                <option value="Campus 3">Campus 3</option>
            </select>
        </div>

        <button class="btn" onclick="goToLevelSelection()">Continue ‚û°Ô∏è</button>
    </div>

    <!-- Screen 2: Level Selection -->
    <div id="level-screen" class="screen">
        <h1>Select Level</h1>
        <p>Which grade level is <span id="display-student-name" style="font-weight:bold; color:var(--primary)">the student</span> applying for?</p>
        <div class="level-grid" id="level-buttons">
            <!-- Buttons generated by JS -->
        </div>
        <br>
        <button class="btn" style="background:#999; font-size: 0.8rem;" onclick="location.reload()">‚¨ÖÔ∏è Back</button>
    </div>

    <!-- Screen 3: Quiz -->
    <div id="quiz-screen" class="screen">
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="subject-badge" id="subject-badge">Subject</div>
        
        <!-- Audio Controls -->
        <div class="audio-controls">
            <!-- Story Button: Shows ONLY if isStory=true -->
            <button id="btn-listen-story" class="btn-speak btn-story" style="display:none;" onclick="playListeningStory()">üîä Listen to Story</button>
            
            <!-- Read Question Button: Shows for ALL questions -->
            <button id="btn-read-question" class="btn-speak btn-read-q" onclick="speakQuestionText()">üó£Ô∏è Read Question</button>
        </div>

        <h3 id="question-text" style="font-size: 1.4rem; margin: 10px 0; color: var(--primary);">Question text...</h3>
        
        <!-- Display for Reading/Writing Prompts -->
        <div id="prompt-display" style="font-size: 1.2rem; color: #555; margin-bottom: 20px; display:none;"></div>

        <!-- Writing Input (Visible to student in Writing Section) -->
        <div id="writing-container" style="display:none; text-align:left;">
            <div class="input-group">
                <label>Student Answer:</label>
                <textarea id="writing-input" rows="6" placeholder="Student types here..."></textarea>
            </div>
        </div>

        <!-- MCQ Options -->
        <div id="options-container">
            <!-- Options generated by JS -->
        </div>

        <!-- Assessor Grading Buttons (Hidden by default) -->
        <div id="assessor-grading-container" class="grading-grid" style="display:none;">
            <button class="btn-grade grade-100" onclick="gradeAssessorTask(100)">Excellent (100%)</button>
            <button class="btn-grade grade-80" onclick="gradeAssessorTask(80)">Good (80%)</button>
            <button class="btn-grade grade-60" onclick="gradeAssessorTask(60)">Average (60%)</button>
            <button class="btn-grade grade-40" onclick="gradeAssessorTask(40)">Below Avg (40%)</button>
            <button class="btn-grade grade-20" onclick="gradeAssessorTask(20)">Needs Support (20%)</button>
            <button class="btn-grade grade-0" onclick="gradeAssessorTask(0)">No Response (0%)</button>
        </div>

        <br>
        <button class="btn" id="next-btn" style="display:none; width: 100%;" onclick="nextQuestion()">Next Question ‚û°Ô∏è</button>
    </div>

    <!-- Screen 4: Results -->
    <div id="result-screen" class="screen">
        <h1>Assessment Report</h1>
        <p>Placement Test Results</p>
        
        <!-- Visual Score Card -->
        <div class="score-card" id="screen-score-card">
            <div class="info-row">
                <span><strong>Student:</strong> <span id="res-student"></span></span>
                <span><strong>Assessor:</strong> <span id="res-assessor"></span></span>
            </div>
            <div class="info-row">
                <span><strong>Campus:</strong> <span id="res-campus"></span></span>
                <span><strong>Level:</strong> <span id="res-level"></span></span>
            </div>
            <div class="info-row" style="border:none; padding-bottom:0;">
                <span><strong>Date:</strong> <span id="res-date"></span></span>
            </div>
            <hr>
            <h3>Score Breakdown:</h3>
            <p><strong>üá¨üáß English (50%):</strong> <span id="score-eng">0</span>%</p>
            <p><strong>üßÆ Math (30%):</strong> <span id="score-math">0</span>%</p>
            <p><strong>üî¨ Science (20%):</strong> <span id="score-sci">0</span>%</p>
            <hr>
            <h2 style="color:var(--primary)">Final Score: <span id="final-score">0</span>/100</h2>
        </div>

        <div id="final-verdict" style="margin-bottom: 20px;"></div>
        
        <!-- Webhook Status Indicator -->
        <div id="upload-status"></div>
        <br>
        
        <!-- Download PDF Button -->
        <button class="btn" style="background: #e53935;" onclick="downloadPDF()">Download PDF Report üì•</button>
        <br><br>
        
        <button class="btn" onclick="location.reload()">Start New Assessment üîÑ</button>
        <br><br>
        <button class="btn" style="background: #333;" onclick="window.print()">Print Report üñ®Ô∏è</button>
    </div>
</div>

<!-- MODERN PDF TEMPLATE -->
<div id="pdf-export-container">
    <div class="pdf-header-bar">
        <!-- Logo REMOVED from PDF Header -->
        <div class="pdf-title-wrapper">
            <h1>Vision Bridge International Academy</h1>
            <p>Official Digital Placement Report</p>
        </div>
    </div>

    <div class="pdf-body">
        <!-- Modern Grid Layout for Info -->
        <div class="pdf-info-grid">
            <div class="pdf-info-row">
                <div class="pdf-info-cell">
                    <span class="pdf-label">Candidate Name</span>
                    <span class="pdf-value" id="pdf-student">Student Name</span>
                </div>
                <div class="pdf-info-cell">
                    <span class="pdf-label">Campus</span>
                    <span class="pdf-value" id="pdf-campus">Campus Name</span>
                </div>
            </div>
            <div class="pdf-info-row">
                <div class="pdf-info-cell">
                    <span class="pdf-label">Assessment Date</span>
                    <span class="pdf-value" id="pdf-date">Date</span>
                </div>
                <div class="pdf-info-cell">
                    <span class="pdf-label">Assessed By</span>
                    <span class="pdf-value" id="pdf-assessor">Teacher Name</span>
                </div>
            </div>
        </div>

        <!-- Clean Score Table -->
        <table class="pdf-table">
            <thead>
                <tr>
                    <th>Subject Area</th>
                    <th>Weight</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>üá¨üáß English Language</td>
                    <td>50%</td>
                    <td id="pdf-eng-score">0%</td>
                </tr>
                <tr>
                    <td>üßÆ Mathematics</td>
                    <td>30%</td>
                    <td id="pdf-math-score">0%</td>
                </tr>
                <tr>
                    <td>üî¨ Science</td>
                    <td>20%</td>
                    <td id="pdf-sci-score">0%</td>
                </tr>
                <tr class="total-row">
                    <td colspan="2">FINAL WEIGHTED SCORE</td>
                    <td id="pdf-final-score">0/100</td>
                </tr>
            </tbody>
        </table>

        <!-- Verdict Badge (UPDATED FORMAT) -->
        <div class="pdf-verdict-container">
            <div id="pdf-verdict-box" class="pdf-verdict-badge">
                <!-- Content injected via JS -->
            </div>
        </div>

        <!-- Footer / Signature -->
        <div class="pdf-footer">
            <div>
                <div class="signature-line">Assessor Signature</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATABASE WITH LISTENING & WRITING (K2 - P6) ---
    // Added isStory flag to questions related to the story
    const quizData = {
        "K2": {
            "English": {
                story: "The cat is on the mat. The cat is happy.",
                questions: [
                    { q: "Where is the cat?", options: ["On the mat", "In the box", "Under the table", "On the chair"], ans: 0, isStory: true },
                    { q: "How does the cat feel?", options: ["Sad", "Happy", "Angry", "Sleepy"], ans: 1, isStory: true },
                    { q: "Which letter starts the word 'Apple'?", options: ["B", "A", "C", "D"], ans: 1 },
                    { q: "Look at the picture of a üê±. What is it?", options: ["Dog", "Cat", "Cow", "Pig"], ans: 1 }
                ],
                writingPrompt: "Write your name (Assessor Grades).",
                readingPrompt: "Read aloud: 'The dog runs fast.'"
            },
            "Math": [
                { q: "Count the stars: ‚òÖ ‚òÖ ‚òÖ", options: ["2", "4", "3", "5"], ans: 2 },
                { q: "What is 2 + 2?", options: ["3", "4", "5", "6"], ans: 1 }
            ],
            "Science": [
                { q: "Is a dog a living thing?", options: ["Yes", "No"], ans: 0 },
                { q: "We use our eyes to:", options: ["Hear", "See", "Smell", "Touch"], ans: 1 }
            ]
        },
        "P1": {
            "English": {
                story: "Tom has a red ball. He plays in the park with his dog.",
                questions: [
                    { q: "What does Tom have?", options: ["A blue car", "A red ball", "A green hat", "A yellow bike"], ans: 1, isStory: true },
                    { q: "The cat is sleeping _____ the bed.", options: ["on", "happy", "run", "fast"], ans: 0 }
                ],
                writingPrompt: "Write about your favorite toy.",
                readingPrompt: "Read aloud: 'I like to play with my friends.'"
            },
            "Math": [{ q: "What is 5 + 4?", options: ["8", "9", "10", "7"], ans: 1 }],
            "Science": [{ q: "What do humans need to live?", options: ["Candy", "Toys", "Water", "TV"], ans: 2 }]
        },
        "P2": {
            "English": {
                story: "Sarah goes to the zoo.",
                questions: [
                    { q: "Where does Sarah go?", options: ["To school", "To the park", "To the zoo", "To the shop"], ans: 2, isStory: true }
                ],
                writingPrompt: "Write about your favorite animal.",
                readingPrompt: "Read aloud: 'The elephant has a long trunk.'"
            },
            "Math": [{ q: "What is 100 + 50?", options: ["105", "150", "500", "115"], ans: 1 }],
            "Science": [{ q: "The sun gives us light and ______?", options: ["Water", "Heat", "Rain", "Sound"], ans: 1 }]
        },
        "P3": {
             "English": {
                story: "Jack wakes up at 6 AM.",
                questions: [{ q: "When does Jack wake up?", options: ["7 AM", "6 AM", "8 AM", "5 AM"], ans: 1, isStory: true }],
                writingPrompt: "Describe your morning routine.",
                readingPrompt: "Read aloud: 'We walk to school every day.'"
            },
            "Math": [{ q: "What is 24 divided by 4?", options: ["5", "6", "8", "12"], ans: 1 }],
            "Science": [{ q: "Which animal lays eggs?", options: ["Dog", "Cat", "Chicken", "Cow"], ans: 2 }]
        },
        "P4": {
             "English": {
                story: "Football is a popular sport.",
                questions: [{ q: "What do players need?", options: ["Sleepy", "Fast and strong", "Quiet", "Loud"], ans: 1, isStory: true }],
                writingPrompt: "What is your favorite sport?",
                readingPrompt: "Read aloud: 'Teamwork is very important in sports.'"
            },
            "Math": [{ q: "What is 7 x 8?", options: ["54", "56", "48", "64"], ans: 1 }],
            "Science": [{ q: "What happens when water freezes?", options: ["Gas", "Solid (Ice)", "Disappears", "Hot"], ans: 1 }]
        },
        "P5": {
             "English": {
                story: "The solar system has eight planets.",
                questions: [{ q: "Which planet is hottest?", options: ["Mercury", "Earth", "Mars", "Venus"], ans: 3, isStory: true }],
                writingPrompt: "Write a fact about space.",
                readingPrompt: "Read aloud: 'Earth is the only planet known to have life.'"
            },
            "Math": [{ q: "What is 12 squared?", options: ["24", "144", "120", "100"], ans: 1 }],
            "Science": [{ q: "Which force pulls objects to Earth?", options: ["Friction", "Magnetism", "Gravity", "Tension"], ans: 2 }]
        },
        "P6": {
             "English": {
                story: "Climate change is a global issue.",
                questions: [{ q: "What causes climate change?", options: ["Trees", "Recycling", "Greenhouse gases", "Energy"], ans: 2, isStory: true }],
                writingPrompt: "Why should we protect nature?",
                readingPrompt: "Read aloud: 'Renewable energy helps reduce pollution.'"
            },
            "Math": [{ q: "Calculate 3 + 4 x 5", options: ["35", "23", "20", "60"], ans: 1 }],
            "Science": [{ q: "Chemical symbol for Oxygen?", options: ["Ox", "O2", "H2O", "Co2"], ans: 1 }]
        }
    };

    // --- VARIABLES ---
    let currentLevel = "";
    let flatQuestions = [];
    let currentQIndex = 0;
    
    // Scores
    let scores = { English: 0, Math: 0, Science: 0 };
    let maxScores = { English: 0, Math: 0, Science: 0 };
    
    // Assessor scores for English sub-components
    let englishComponents = {
        mcqScore: 0,
        mcqMax: 0,
        readingScorePct: 0, // Percentage
        writingScorePct: 0  // Percentage
    };

    let selectedOption = null;
    let studentName = "";
    let assessorName = "";
    let selectedCampus = "";
    let studentWriting = ""; // Capture student text

    function init() {
        const btnContainer = document.getElementById("level-buttons");
        Object.keys(quizData).forEach(level => {
            let btn = document.createElement("button");
            btn.className = "btn";
            btn.innerText = level;
            btn.onclick = () => startQuiz(level);
            btnContainer.appendChild(btn);
        });
    }

    // New Function to handle Registration
    function goToLevelSelection() {
        const sName = document.getElementById("student-name").value;
        const aName = document.getElementById("assessor-name").value;
        const campus = document.getElementById("campus-select").value;

        if (sName.trim() === "" || aName.trim() === "" || campus === "") {
            alert("Please fill in all details including the Campus.");
            return;
        }

        studentName = sName;
        assessorName = aName;
        selectedCampus = campus;

        document.getElementById("registration-screen").classList.remove("active");
        document.getElementById("level-screen").classList.add("active");
    }

    function startQuiz(level) {
        currentLevel = level;
        flatQuestions = [];
        scores = { English: 0, Math: 0, Science: 0 };
        maxScores = { English: 0, Math: 0, Science: 0 };
        englishComponents = { mcqScore: 0, mcqMax: 0, readingScorePct: 0, writingScorePct: 0 };
        currentQIndex = 0;
        studentWriting = "";

        // Build flat array
        // 1. English MCQs
        if (quizData[level]["English"]) {
             const engData = quizData[level]["English"];
             engData.questions.forEach(q => {
                 flatQuestions.push({ ...q, subject: "English", type: "mcq" });
                 maxScores["English"]++; 
                 englishComponents.mcqMax++;
             });
             // Add Reading Task (Assessor Graded)
             flatQuestions.push({ 
                 subject: "English", 
                 type: "assessor_grade", 
                 subType: "Reading",
                 prompt: engData.readingPrompt
             });
             // Add Writing Task (Student Types + Assessor Graded)
             flatQuestions.push({ 
                 subject: "English", 
                 type: "assessor_grade", 
                 subType: "Writing",
                 prompt: engData.writingPrompt
             });
        }
        
        // 2. Math
        if (quizData[level]["Math"]) {
            quizData[level]["Math"].forEach(q => {
                flatQuestions.push({ ...q, subject: "Math", type: "mcq" });
                maxScores["Math"]++;
            });
        }

        // 3. Science
        if (quizData[level]["Science"]) {
            quizData[level]["Science"].forEach(q => {
                flatQuestions.push({ ...q, subject: "Science", type: "mcq" });
                maxScores["Science"]++;
            });
        }

        document.getElementById("level-screen").classList.remove("active");
        document.getElementById("quiz-screen").classList.add("active");
        loadQuestion();
    }

    // Function to read the question text
    function speakQuestionText() {
        // Use prompt text if available (for Reading/Writing), otherwise question text
        let text = "";
        const promptDisplay = document.getElementById("prompt-display");
        
        if (promptDisplay.style.display !== "none") {
            // It's a reading/writing prompt
             text = promptDisplay.innerText.replace("Task: ", "");
        } else {
            // It's a standard question
             text = document.getElementById("question-text").innerText;
        }

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9; 
        window.speechSynthesis.speak(utterance);
    }
    
    // Function for the Story Button
    function playListeningStory() {
        const story = quizData[currentLevel]["English"]?.story;
        if(story) {
            const utterance = new SpeechSynthesisUtterance(story);
            utterance.rate = 0.85; 
            window.speechSynthesis.speak(utterance);
        }
    }

    function loadQuestion() {
        if (currentQIndex >= flatQuestions.length) {
            showResults();
            return;
        }

        const qData = flatQuestions[currentQIndex];
        
        // Reset UI elements
        document.getElementById("options-container").style.display = "none";
        document.getElementById("assessor-grading-container").style.display = "none";
        document.getElementById("writing-container").style.display = "none"; 
        document.getElementById("next-btn").style.display = "none";
        document.getElementById("btn-listen-story").style.display = "none"; // Hide Story Button
        document.getElementById("prompt-display").style.display = "none";

        document.getElementById("subject-badge").innerText = qData.subject + " - " + "Step " + (currentQIndex + 1) + " of " + flatQuestions.length;
        
        // --- 1. Assessor Grading Task ---
        if (qData.type === "assessor_grade") {
            document.getElementById("question-text").innerText = "ASSESSOR GRADING: " + qData.subType;
            document.getElementById("question-text").style.color = "#e53935"; 
            
            document.getElementById("prompt-display").innerText = "Task: " + qData.prompt;
            document.getElementById("prompt-display").style.display = "block";
            
            if (qData.subType === "Writing") {
                document.getElementById("writing-container").style.display = "block";
            }
            
            document.getElementById("assessor-grading-container").style.display = "grid";
        
        // --- 2. Standard MCQ ---
        } else {
            document.getElementById("question-text").innerText = qData.q;
            document.getElementById("question-text").style.color = "var(--primary)";
            document.getElementById("options-container").style.display = "block";
            
            // LOGIC: Show Listen Story button ONLY if isStory is true
            if (qData.subject === "English" && qData.isStory === true) {
                 document.getElementById("btn-listen-story").style.display = "inline-flex";
            }

            const optContainer = document.getElementById("options-container");
            optContainer.innerHTML = "";
            selectedOption = null;

            qData.options.forEach((opt, idx) => {
                let btn = document.createElement("button");
                btn.className = "btn-option";
                btn.innerText = opt;
                btn.onclick = () => selectOption(idx, btn);
                optContainer.appendChild(btn);
            });
        }
        
        const pct = ((currentQIndex) / flatQuestions.length) * 100;
        document.getElementById("progress-bar").style.width = pct + "%";
    }

    function selectOption(index, btnElement) {
        selectedOption = index;
        document.querySelectorAll(".btn-option").forEach(b => b.classList.remove("selected"));
        btnElement.classList.add("selected");
        document.getElementById("next-btn").style.display = "inline-block";
    }
    
    // Function called by Assessor Buttons
    function gradeAssessorTask(scorePercentage) {
        const qData = flatQuestions[currentQIndex];
        
        if (qData.subType === "Reading") {
            englishComponents.readingScorePct = scorePercentage;
        } else if (qData.subType === "Writing") {
            englishComponents.writingScorePct = scorePercentage;
            const inputVal = document.getElementById("writing-input").value;
            if(inputVal) studentWriting = inputVal;
        }
        
        currentQIndex++;
        loadQuestion();
    }

    function nextQuestion() {
        window.speechSynthesis.cancel();
        
        const qData = flatQuestions[currentQIndex];
        if (qData.type === "mcq" && selectedOption === qData.ans) {
            scores[qData.subject]++;
            if(qData.subject === "English") {
                englishComponents.mcqScore++;
            }
        }
        currentQIndex++;
        loadQuestion();
    }

    function showResults() {
        document.getElementById("quiz-screen").classList.remove("active");
        document.getElementById("result-screen").classList.add("active");

        let engMcqPct = (englishComponents.mcqScore / englishComponents.mcqMax) * 100 || 0;
        let finalEngPct = (engMcqPct * 0.4) + (englishComponents.readingScorePct * 0.3) + (englishComponents.writingScorePct * 0.3);

        let mathPct = (scores.Math / maxScores.Math) * 100 || 0;
        let sciPct = (scores.Science / maxScores.Science) * 100 || 0;

        let weightedScore = (finalEngPct * 0.50) + (mathPct * 0.30) + (sciPct * 0.20);
        weightedScore = Math.round(weightedScore);

        document.getElementById("score-eng").innerText = Math.round(finalEngPct);
        document.getElementById("score-math").innerText = Math.round(mathPct);
        document.getElementById("score-sci").innerText = Math.round(sciPct);
        document.getElementById("final-score").innerText = weightedScore;

        const verdict = document.getElementById("final-verdict");
        const statusText = weightedScore >= 60 ? "PASSED" : "REVIEW NEEDED";

        if (weightedScore >= 60) {
            verdict.innerHTML = "<h2 class='pass'>PASSED ‚úÖ</h2><p>Excellent! The student is ready for " + currentLevel + ".</p>";
        } else {
            verdict.innerHTML = "<h2 class='fail'>REVIEW NEEDED ‚ö†Ô∏è</h2><p>The student may need support in English or core subjects.</p>";
        }

        const payload = {
            student_name: studentName,
            assessor_name: assessorName,
            campus: selectedCampus,
            level_applied: currentLevel,
            date: new Date().toLocaleDateString(),
            scores: {
                english: Math.round(finalEngPct),
                math: Math.round(mathPct),
                science: Math.round(sciPct)
            },
            writing_response: studentWriting, 
            final_score: weightedScore,
            result: statusText
        };

        fetch("https://calixtojohnn.app.n8n.cloud/webhook/4cecec6e-b2f2-46c1-98fc-b3b11ccf3932", {
            method: "POST",
            mode: "no-cors", 
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
        }).catch(error => { console.warn("Webhook Sync Issue:", error); });
    }

    // --- PDF Download Logic ---
    function downloadPDF() {
        const element = document.getElementById('pdf-export-container');
        
        // Prepare content 
        const mainLogoSrc = document.getElementById('main-logo').src;
        // Logic to safely set image src if needed
        
        const writingBox = document.getElementById('pdf-writing-text');
        // Check if element exists before setting innerText
        if(writingBox) {
             if (studentWriting && studentWriting.trim() !== "") {
                writingBox.innerText = studentWriting;
            } else {
                writingBox.innerText = "(Student left the writing section blank)";
            }
        }

        const engPct = document.getElementById("score-eng").innerText;
        const mathPct = document.getElementById("score-math").innerText;
        const sciPct = document.getElementById("score-sci").innerText;
        const finalScore = document.getElementById("final-score").innerText;
        const date = document.getElementById("res-date").innerText;
        const verdictText = parseInt(finalScore) >= 60 ? "PASSED ‚úÖ" : "REVIEW NEEDED ‚ö†Ô∏è";
        
        let verdictSubtitle = "";
        if (parseInt(finalScore) >= 60) {
            verdictSubtitle = "Excellent! The student is ready for " + currentLevel + ".";
        } else {
            verdictSubtitle = "The student may need support in English or core subjects.";
        }
        
        document.getElementById('pdf-student').innerText = studentName;
        document.getElementById('pdf-campus').innerText = selectedCampus;
        document.getElementById('pdf-date').innerText = date;
        document.getElementById('pdf-assessor').innerText = assessorName;

        document.getElementById('pdf-eng-score').innerText = engPct + "%";
        document.getElementById('pdf-math-score').innerText = mathPct + "%";
        document.getElementById('pdf-sci-score').innerText = sciPct + "%";
        document.getElementById('pdf-final-score').innerText = finalScore + "/100";

        const verdictBox = document.getElementById('pdf-verdict-box');
        verdictBox.innerHTML = `
            <span class="pdf-verdict-title">${verdictText}</span>
            <span class="pdf-verdict-subtitle">${verdictSubtitle}</span>
        `;
        
        if (parseInt(finalScore) >= 60) {
            verdictBox.style.backgroundColor = "#e8f5e9"; 
            verdictBox.style.border = "2px solid #2e7d32";
            verdictBox.querySelector('.pdf-verdict-title').style.color = "#2e7d32";
        } else {
            verdictBox.style.backgroundColor = "#ffebee";
            verdictBox.style.border = "2px solid #e53935";
            verdictBox.querySelector('.pdf-verdict-title').style.color = "#e53935";
        }
        
        element.style.display = 'block';
        
        const opt = {
            margin:       0,
            filename:     `Result_${studentName.replace(/\s+/g, '_')}_${currentLevel}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, scrollY: 0 },
            jsPDF:        { unit: 'pt', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none';
        });
    }

    init();
</script>
</body>
</html>
